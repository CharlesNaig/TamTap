<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAMTAP - Admin Panel</title>
    <link rel="icon" type="image/png" href="/assets/TamTap-3D.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                screens: {
                    'xs': '360px',
                    'sm': '480px',
                    'md': '768px',
                    'lg': '1024px',
                    'xl': '1280px',
                    '2xl': '1536px',
                    '3xl': '1920px'
                },
                extend: {
                    colors: {
                        'feu-green': '#0a8249',
                        'feu-green-dark': '#034c16',
                        'feu-green-light': '#0eb063',
                        'feu-gold': '#FFD700'
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Preloader -->
    <link rel="stylesheet" href="/css/preloader.css">
    <script src="/js/preloader.js"></script>
    <style>
        /* Della Respira Brand Font */
        @font-face {
            font-family: 'Della Respira';
            src: url('/assets/fonts/DellaRespira-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        .font-brand { font-family: 'Della Respira', Georgia, serif; }

        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .tab-active { border-bottom: 3px solid #0a8249; color: #0a8249; }
        
        /* Dropdown Menu Animation */
        .dropdown-enter { animation: dropdownFade 0.2s ease-out; }
        @keyframes dropdownFade { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Active Nav Link */
        .nav-active { position: relative; color: #0a8249; }
        .nav-active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #0a8249, #0eb063);
            border-radius: 3px 3px 0 0;
        }
        
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s ease-in-out infinite;
        }
        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-text { border-radius: 4px; height: 1rem; }
        .skeleton-text-sm { border-radius: 3px; height: 0.75rem; }
        .skeleton-circle { border-radius: 50%; }
        
        /* Auth Protection - Hide until verified */
        .auth-loading {
            visibility: hidden;
        }
        
        /* Console Output Styling */
        .console-output {
            -ms-overflow-style: thin;
        }
        @supports (scrollbar-width: thin) {
            .console-output {
                scrollbar-width: thin;
                scrollbar-color: #4b5563 #1f2937;
            }
        }
        .console-output::-webkit-scrollbar {
            width: 6px;
        }
        .console-output::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .console-output::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }
        .console-output::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Pulse animation for live indicator */
        @keyframes pulse-live {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse { animation: pulse-live 1.5s ease-in-out infinite; }
    </style>
    <!-- Socket.IO for live logs -->
    <script src="/socket.io/socket.io.js" defer></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col auth-loading">
    <!-- ========================================
         TOP BAR (Green with Address)
    ======================================== -->
    <div class="bg-feu-green text-white text-xs sm:text-sm py-1.5 sm:py-2 px-3 sm:px-4 lg:px-6">
        <div class="w-full max-w-[1920px] mx-auto flex items-center justify-between">
            <!-- Left: Address -->
            <div class="flex items-center gap-1.5 sm:gap-2">
                <i class="fas fa-location-dot text-xs sm:text-sm"></i>
                <span class="hidden lg:inline">504 J. P. Rizal St, Marikina, 1800 Metro Manila</span>
                <span class="hidden sm:inline lg:hidden">FEU Roosevelt Marikina</span>
                <span class="sm:hidden text-xs">FEU Roosevelt</span>
            </div>
            <!-- Right: Admin Badge -->
            <div class="flex items-center gap-3">
                <span class="px-2 py-0.5 rounded-full text-xs bg-feu-gold text-feu-green-dark font-bold inline-flex items-center gap-1">
                    <i class="fas fa-shield-halved"></i>
                    <span class="hidden sm:inline">System Admin</span>
                </span>
            </div>
        </div>
    </div>

    <!-- ========================================
         HEADER (White with Logo and Nav)
    ======================================== -->
    <header class="bg-white py-3 sm:py-4 lg:py-5 px-3 sm:px-4 lg:px-6 xl:px-8 shadow-sm border-b">
        <div class="w-full max-w-[1920px] mx-auto flex items-center justify-between">
            <!-- Left: Logo -->
            <div class="flex items-center gap-2 sm:gap-3 lg:gap-4">
                <img src="/assets/TamTap-3D.png" 
                     alt="TAMTAP Mascot" 
                     class="h-10 w-10 sm:h-12 sm:w-12 lg:h-14 lg:w-14 xl:h-16 xl:w-16 object-contain"
                     onerror="this.src='/assets/TamTap.png'; this.onerror=null;">
                <div>
                    <span class="font-brand text-lg sm:text-xl lg:text-2xl xl:text-3xl font-bold">
                        <span class="text-feu-green">TAM</span><span class="text-feu-gold">TAP</span>
                    </span>
                    <p class="text-[10px] sm:text-xs lg:text-sm text-gray-500 font-medium">Admin Panel</p>
                </div>
            </div>

            <!-- Center: Navigation (Desktop) -->
            <nav class="hidden lg:flex items-center gap-1">
                <a href="/dashboard" class="px-4 py-2 text-gray-600 hover:text-feu-green hover:bg-gray-50 rounded-lg transition font-medium">
                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                </a>
                <a href="/admin" class="nav-active px-4 py-2 text-feu-green font-semibold rounded-lg">
                    <i class="fas fa-cog mr-2"></i>Admin Panel
                </a>
            </nav>

            <!-- Right: User Menu -->
            <div class="flex items-center gap-2 sm:gap-3">
                <!-- Mobile Nav Toggle -->
                <div class="lg:hidden flex items-center gap-1 mr-2">
                    <a href="/dashboard" class="p-2 text-gray-500 hover:text-feu-green hover:bg-gray-100 rounded-lg transition" title="Dashboard">
                        <i class="fas fa-chart-line"></i>
                    </a>
                </div>
                
                <!-- User Dropdown -->
                <div class="relative">
                    <button onclick="toggleSettingsMenu()" 
                            class="flex items-center gap-1.5 sm:gap-2 hover:bg-gray-100 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg transition border border-gray-200">
                        <div class="w-7 h-7 sm:w-8 sm:h-8 bg-feu-gold rounded-full flex items-center justify-center text-feu-green-dark font-bold text-xs sm:text-sm">
                            <i class="fas fa-user-shield text-xs sm:text-sm"></i>
                        </div>
                        <span id="user-name" class="hidden md:inline text-sm font-medium text-gray-700 max-w-[120px] truncate">Admin</span>
                        <i class="fas fa-chevron-down text-[10px] sm:text-xs text-gray-400"></i>
                    </button>
                    
                    <!-- Settings Dropdown Menu -->
                    <div id="settings-menu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-xl z-50 border dropdown-enter overflow-hidden">
                        <div class="p-4 bg-gradient-to-r from-feu-green to-feu-green-dark text-white">
                            <p id="menu-user-name" class="font-bold">System Admin</p>
                            <p id="menu-user-role" class="text-sm text-white/80 capitalize">Administrator</p>
                        </div>
                        <ul class="py-2">
                            <li>
                                <a href="/dashboard" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-50 flex items-center gap-3 transition">
                                    <i class="fas fa-chart-line text-feu-green w-5"></i> View Dashboard
                                </a>
                            </li>
                            <li>
                                <button onclick="showPersonalInfo()" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-50 flex items-center gap-3 transition">
                                    <i class="fas fa-user text-feu-green w-5"></i> Personal Information
                                </button>
                            </li>
                            <li class="border-t mt-2 pt-2">
                                <button onclick="logout()" class="w-full text-left px-4 py-3 text-red-600 hover:bg-red-50 flex items-center gap-3 transition">
                                    <i class="fas fa-right-from-bracket w-5"></i> Log Out
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="w-full max-w-[1920px] mx-auto px-3 sm:px-4 lg:px-6 xl:px-8 py-4 sm:py-6 flex-1">
        <!-- Tab Navigation -->
        <div class="bg-white rounded-lg shadow mb-4 sm:mb-6">
            <div class="flex border-b overflow-x-auto">
                <button onclick="showTab('teachers')" id="tab-teachers" 
                        class="tab-btn px-4 sm:px-6 py-3 sm:py-4 font-medium text-sm sm:text-base text-gray-600 hover:text-feu-green border-b-2 border-transparent tab-active whitespace-nowrap">
                    <i class="fas fa-chalkboard-teacher mr-1 sm:mr-2"></i>Teachers
                </button>
                <button onclick="showTab('students')" id="tab-students"
                        class="tab-btn px-4 sm:px-6 py-3 sm:py-4 font-medium text-sm sm:text-base text-gray-600 hover:text-feu-green border-b-2 border-transparent whitespace-nowrap">
                    <i class="fas fa-user-graduate mr-1 sm:mr-2"></i>Students
                </button>
                <button onclick="showTab('sections')" id="tab-sections"
                        class="tab-btn px-4 sm:px-6 py-3 sm:py-4 font-medium text-sm sm:text-base text-gray-600 hover:text-feu-green border-b-2 border-transparent whitespace-nowrap">
                    <i class="fas fa-users mr-1 sm:mr-2"></i>Sections
                </button>
                <button onclick="showTab('schedules')" id="tab-schedules"
                        class="tab-btn px-4 sm:px-6 py-3 sm:py-4 font-medium text-sm sm:text-base text-gray-600 hover:text-feu-green border-b-2 border-transparent whitespace-nowrap">
                    <i class="fas fa-calendar-alt mr-1 sm:mr-2"></i>Schedules
                </button>
                <button onclick="showTab('logs')" id="tab-logs"
                        class="tab-btn px-4 sm:px-6 py-3 sm:py-4 font-medium text-sm sm:text-base text-gray-600 hover:text-feu-green border-b-2 border-transparent whitespace-nowrap">
                    <i class="fas fa-terminal mr-1 sm:mr-2"></i>System Logs
                </button>
            </div>
        </div>

        <!-- Teachers Tab -->
        <div id="panel-teachers" class="tab-panel">
            <div class="bg-white rounded-lg shadow">
                <div class="p-3 sm:p-4 border-b flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                    <h2 class="text-base sm:text-lg font-semibold text-gray-700"><i class="fas fa-chalkboard-teacher mr-2 text-feu-green"></i>Teacher Accounts</h2>
                    <button onclick="showAddTeacherModal()" class="bg-feu-green hover:bg-feu-green-dark text-white px-3 sm:px-4 py-2 rounded text-sm transition-colors w-full sm:w-auto">
                        <i class="fas fa-plus mr-1"></i>Add Teacher
                    </button>
                </div>
                <!-- Desktop Table -->
                <div class="overflow-x-auto hidden sm:block">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Email</th>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sections</th>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="teachers-table-skeleton" class="divide-y divide-gray-200">
                            <tr><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text w-20"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text w-32"></div></td><td class="px-3 lg:px-4 py-3 hidden md:table-cell"><div class="skeleton skeleton-text w-36"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text-sm w-16"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text-sm w-20"></div></td></tr>
                            <tr><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text w-24"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text w-28"></div></td><td class="px-3 lg:px-4 py-3 hidden md:table-cell"><div class="skeleton skeleton-text w-32"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text-sm w-20"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text-sm w-20"></div></td></tr>
                            <tr><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text w-18"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text w-36"></div></td><td class="px-3 lg:px-4 py-3 hidden md:table-cell"><div class="skeleton skeleton-text w-28"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text-sm w-12"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text-sm w-20"></div></td></tr>
                        </tbody>
                        <tbody id="teachers-table" class="hidden divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <!-- Mobile Cards -->
                <div id="teachers-cards-skeleton" class="sm:hidden p-3 space-y-3">
                    <div class="border rounded-lg p-3"><div class="flex justify-between items-center"><div><div class="skeleton skeleton-text w-24 mb-2"></div><div class="skeleton skeleton-text-sm w-32"></div></div><div class="skeleton skeleton-text-sm w-16"></div></div></div>
                    <div class="border rounded-lg p-3"><div class="flex justify-between items-center"><div><div class="skeleton skeleton-text w-28 mb-2"></div><div class="skeleton skeleton-text-sm w-28"></div></div><div class="skeleton skeleton-text-sm w-16"></div></div></div>
                </div>
                <div id="teachers-cards" class="hidden sm:hidden p-3 space-y-3">
                </div>
            </div>
        </div>

        <!-- Students Tab -->
        <div id="panel-students" class="tab-panel hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-3 sm:p-4 border-b flex flex-col lg:flex-row justify-between items-start lg:items-center gap-3">
                    <h2 class="text-base sm:text-lg font-semibold text-gray-700"><i class="fas fa-user-graduate mr-2 text-feu-green"></i>Student Records</h2>
                    <div class="flex flex-wrap gap-2 w-full lg:w-auto">
                        <select id="student-section-filter" onchange="loadStudents()" 
                                title="Filter by section"
                                class="border rounded px-3 py-2 text-sm flex-1 sm:flex-none">
                            <option value="">All Sections</option>
                        </select>
                        <button onclick="showAddStudentModal()" class="bg-feu-green hover:bg-feu-green-dark text-white px-3 sm:px-4 py-2 rounded text-sm transition-colors flex-1 sm:flex-none">
                            <i class="fas fa-plus mr-1"></i><span class="hidden xs:inline">Add</span> Student
                        </button>
                        <button onclick="showBulkImportModal()" class="bg-feu-gold hover:bg-yellow-500 text-feu-green-dark px-3 sm:px-4 py-2 rounded text-sm font-medium transition-colors flex-1 sm:flex-none">
                            <i class="fas fa-file-csv mr-1"></i><span class="hidden xs:inline">Import</span> CSV
                        </button>
                    </div>
                </div>
                <!-- Desktop Table -->
                <div class="overflow-x-auto hidden sm:block">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden lg:table-cell">NFC ID</th>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Grade</th>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Section</th>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-skeleton" class="divide-y divide-gray-200">
                            <tr><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text w-8"></div></td><td class="px-3 lg:px-4 py-3 hidden lg:table-cell"><div class="skeleton skeleton-text w-24"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text w-32"></div></td><td class="px-3 lg:px-4 py-3 hidden md:table-cell"><div class="skeleton skeleton-text-sm w-8"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text-sm w-14"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text-sm w-20"></div></td></tr>
                            <tr><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text w-8"></div></td><td class="px-3 lg:px-4 py-3 hidden lg:table-cell"><div class="skeleton skeleton-text w-28"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text w-28"></div></td><td class="px-3 lg:px-4 py-3 hidden md:table-cell"><div class="skeleton skeleton-text-sm w-8"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text-sm w-14"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text-sm w-20"></div></td></tr>
                            <tr><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text w-8"></div></td><td class="px-3 lg:px-4 py-3 hidden lg:table-cell"><div class="skeleton skeleton-text w-20"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text w-36"></div></td><td class="px-3 lg:px-4 py-3 hidden md:table-cell"><div class="skeleton skeleton-text-sm w-8"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text-sm w-14"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text-sm w-20"></div></td></tr>
                            <tr><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text w-8"></div></td><td class="px-3 lg:px-4 py-3 hidden lg:table-cell"><div class="skeleton skeleton-text w-24"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text w-24"></div></td><td class="px-3 lg:px-4 py-3 hidden md:table-cell"><div class="skeleton skeleton-text-sm w-8"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text-sm w-14"></div></td><td class="px-3 lg:px-4 py-3"><div class="skeleton skeleton-text-sm w-20"></div></td></tr>
                        </tbody>
                        <tbody id="students-table" class="hidden divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <!-- Mobile Cards -->
                <div id="students-cards-skeleton" class="sm:hidden p-3 space-y-3">
                    <div class="border rounded-lg p-3"><div class="flex justify-between items-center"><div><div class="skeleton skeleton-text w-28 mb-2"></div><div class="skeleton skeleton-text-sm w-20"></div></div><div class="skeleton skeleton-text-sm w-14"></div></div></div>
                    <div class="border rounded-lg p-3"><div class="flex justify-between items-center"><div><div class="skeleton skeleton-text w-32 mb-2"></div><div class="skeleton skeleton-text-sm w-24"></div></div><div class="skeleton skeleton-text-sm w-14"></div></div></div>
                    <div class="border rounded-lg p-3"><div class="flex justify-between items-center"><div><div class="skeleton skeleton-text w-24 mb-2"></div><div class="skeleton skeleton-text-sm w-20"></div></div><div class="skeleton skeleton-text-sm w-14"></div></div></div>
                </div>
                <div id="students-cards" class="hidden sm:hidden p-3 space-y-3">
                </div>
            </div>
        </div>

        <!-- Sections Tab -->
        <div id="panel-sections" class="tab-panel hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-3 sm:p-4 border-b">
                    <h2 class="text-base sm:text-lg font-semibold text-gray-700"><i class="fas fa-users mr-2 text-feu-green"></i>Sections Overview</h2>
                    <p class="text-xs sm:text-sm text-gray-500">Sections are auto-created from student records</p>
                </div>
                <div class="p-3 sm:p-4">
                    <div id="sections-grid-skeleton" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4">
                        <div class="border rounded-lg p-4"><div class="skeleton skeleton-text w-20 mb-3"></div><div class="skeleton skeleton-text-sm w-24"></div></div>
                        <div class="border rounded-lg p-4"><div class="skeleton skeleton-text w-16 mb-3"></div><div class="skeleton skeleton-text-sm w-28"></div></div>
                        <div class="border rounded-lg p-4"><div class="skeleton skeleton-text w-20 mb-3"></div><div class="skeleton skeleton-text-sm w-20"></div></div>
                        <div class="border rounded-lg p-4"><div class="skeleton skeleton-text w-18 mb-3"></div><div class="skeleton skeleton-text-sm w-24"></div></div>
                    </div>
                    <div id="sections-grid" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4">
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedules Tab -->
        <div id="panel-schedules" class="tab-panel hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-3 sm:p-4 border-b flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                    <div>
                        <h2 class="text-base sm:text-lg font-semibold text-gray-700"><i class="fas fa-calendar-alt mr-2 text-feu-green"></i>Section Schedules</h2>
                        <p class="text-xs sm:text-sm text-gray-500">Configure daily class times and grace periods per section</p>
                    </div>
                    <div class="flex gap-2 w-full sm:w-auto flex-wrap">
                        <button onclick="downloadScheduleTemplate()" class="flex-1 sm:flex-none bg-gray-500 hover:bg-gray-600 text-white px-3 sm:px-4 py-2 rounded text-sm transition-colors">
                            <i class="fas fa-download mr-1"></i>Template
                        </button>
                        <label class="flex-1 sm:flex-none bg-yellow-500 hover:bg-yellow-600 text-white px-3 sm:px-4 py-2 rounded text-sm transition-colors cursor-pointer text-center">
                            <i class="fas fa-file-upload mr-1"></i>Import
                            <input type="file" id="schedule-xlsx-input" accept=".xlsx,.xls" onchange="importScheduleXLSX()" class="hidden">
                        </label>
                        <button onclick="showAddScheduleModal()" class="flex-1 sm:flex-none bg-feu-green hover:bg-feu-green-dark text-white px-3 sm:px-4 py-2 rounded text-sm transition-colors">
                            <i class="fas fa-plus mr-1"></i>Add
                        </button>
                    </div>
                </div>
                
                <!-- Desktop Table -->
                <div class="overflow-x-auto hidden sm:block">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Section</th>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Adviser</th>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mon-Fri</th>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Saturday</th>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Grace</th>
                                <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="schedules-table-skeleton" class="divide-y divide-gray-200">
                            <tr><td class="px-4 py-3"><div class="skeleton skeleton-text w-16"></div></td><td class="px-4 py-3"><div class="skeleton skeleton-text w-24"></div></td><td class="px-4 py-3"><div class="skeleton skeleton-text w-16"></div></td><td class="px-4 py-3"><div class="skeleton skeleton-text w-14"></div></td><td class="px-4 py-3"><div class="skeleton skeleton-text w-14"></div></td><td class="px-4 py-3"><div class="skeleton skeleton-text w-16"></div></td></tr>
                            <tr><td class="px-4 py-3"><div class="skeleton skeleton-text w-14"></div></td><td class="px-4 py-3"><div class="skeleton skeleton-text w-20"></div></td><td class="px-4 py-3"><div class="skeleton skeleton-text w-16"></div></td><td class="px-4 py-3"><div class="skeleton skeleton-text w-14"></div></td><td class="px-4 py-3"><div class="skeleton skeleton-text w-14"></div></td><td class="px-4 py-3"><div class="skeleton skeleton-text w-16"></div></td></tr>
                        </tbody>
                        <tbody id="schedules-table" class="divide-y divide-gray-200 hidden">
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Cards -->
                <div id="schedules-mobile-skeleton" class="sm:hidden p-3 space-y-3">
                    <div class="border rounded-lg p-3"><div class="skeleton skeleton-text w-20 mb-2"></div><div class="skeleton skeleton-text-sm w-32"></div></div>
                    <div class="border rounded-lg p-3"><div class="skeleton skeleton-text w-16 mb-2"></div><div class="skeleton skeleton-text-sm w-28"></div></div>
                </div>
                <div id="schedules-mobile" class="sm:hidden p-3 space-y-3 hidden">
                </div>
            </div>
        </div>

        <!-- System Logs Tab -->
        <div id="panel-logs" class="tab-panel hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-3 sm:p-4 border-b flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                    <h2 class="text-base sm:text-lg font-semibold text-gray-700">
                        <i class="fas fa-terminal mr-2 text-feu-green"></i>System Console Logs
                        <span id="logs-status" class="ml-2 text-xs font-normal px-2 py-0.5 rounded-full bg-gray-100 text-gray-500">Disconnected</span>
                    </h2>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button onclick="toggleLogStream()" id="btn-stream-toggle" class="bg-feu-green hover:bg-feu-green-dark text-white px-3 sm:px-4 py-2 rounded text-sm transition-colors flex-1 sm:flex-none">
                            <i class="fas fa-play mr-1"></i><span>Start Live</span>
                        </button>
                        <button onclick="clearAllLogs()" class="border border-gray-300 text-gray-600 hover:bg-gray-50 px-3 py-2 rounded text-sm transition-colors">
                            <i class="fas fa-trash-alt mr-1"></i>Clear
                        </button>
                        <button onclick="refreshLogs()" class="border border-gray-300 text-gray-600 hover:bg-gray-50 px-3 py-2 rounded text-sm transition-colors">
                            <i class="fas fa-sync-alt mr-1"></i>Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Console Grid - 3 Terminals -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-0 lg:gap-1 p-1 bg-gray-100">
                    <!-- TAMTAP Buttons Console -->
                    <div class="console-container flex flex-col">
                        <div class="console-header bg-gray-800 text-white px-3 py-2 flex items-center justify-between rounded-t-lg">
                            <div class="flex items-center gap-2">
                                <div class="flex gap-1.5">
                                    <span class="w-3 h-3 rounded-full bg-red-500"></span>
                                    <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                </div>
                                <span class="text-xs font-mono ml-2">tamtap-buttons</span>
                            </div>
                            <span id="status-buttons" class="text-xs text-gray-400"><i class="fas fa-circle text-gray-500 mr-1"></i>idle</span>
                        </div>
                        <div id="console-buttons" class="console-output bg-gray-900 text-green-400 font-mono text-xs p-3 h-64 lg:h-80 overflow-y-auto rounded-b-lg">
                            <div class="text-gray-500">// GPIO Button Controller</div>
                            <div class="text-gray-500">// Waiting for logs...</div>
                        </div>
                    </div>
                    
                    <!-- TAMTAP Service Console (Hardware) -->
                    <div class="console-container flex flex-col">
                        <div class="console-header bg-gray-800 text-white px-3 py-2 flex items-center justify-between rounded-t-lg">
                            <div class="flex items-center gap-2">
                                <div class="flex gap-1.5">
                                    <span class="w-3 h-3 rounded-full bg-red-500"></span>
                                    <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                </div>
                                <span class="text-xs font-mono ml-2">tamtap-hardware</span>
                            </div>
                            <span id="status-hardware" class="text-xs text-gray-400"><i class="fas fa-circle text-gray-500 mr-1"></i>idle</span>
                        </div>
                        <div id="console-hardware" class="console-output bg-gray-900 text-cyan-400 font-mono text-xs p-3 h-64 lg:h-80 overflow-y-auto rounded-b-lg">
                            <div class="text-gray-500">// NFC + Camera Service</div>
                            <div class="text-gray-500">// Waiting for logs...</div>
                        </div>
                    </div>
                    
                    <!-- TAMTAP Server Console (Node.js) -->
                    <div class="console-container flex flex-col">
                        <div class="console-header bg-gray-800 text-white px-3 py-2 flex items-center justify-between rounded-t-lg">
                            <div class="flex items-center gap-2">
                                <div class="flex gap-1.5">
                                    <span class="w-3 h-3 rounded-full bg-red-500"></span>
                                    <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                </div>
                                <span class="text-xs font-mono ml-2">tamtap-server</span>
                            </div>
                            <span id="status-server" class="text-xs text-gray-400"><i class="fas fa-circle text-gray-500 mr-1"></i>idle</span>
                        </div>
                        <div id="console-server" class="console-output bg-gray-900 text-yellow-400 font-mono text-xs p-3 h-64 lg:h-80 overflow-y-auto rounded-b-lg">
                            <div class="text-gray-500">// Node.js Backend Server</div>
                            <div class="text-gray-500">// Waiting for logs...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Log Legend -->
                <div class="p-3 border-t bg-gray-50 flex flex-wrap gap-4 text-xs">
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-400"></span> INFO</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span> WARN</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-400"></span> ERROR</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-cyan-400"></span> DEBUG</span>
                    <span class="text-gray-400 ml-auto">Logs fetched via journalctl from Raspberry Pi systemd services</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Teacher Modal -->
    <div id="add-teacher-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-3 sm:p-4" role="dialog" aria-modal="true" aria-label="Add Teacher">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-[320px] xs:max-w-sm sm:max-w-md fade-in max-h-[90vh] overflow-y-auto">
            <div class="p-3 sm:p-4 border-b flex justify-between items-center sticky top-0 bg-white">
                <h3 class="text-base sm:text-lg font-semibold"><i class="fas fa-user-plus mr-2 text-feu-green"></i>Add New Teacher</h3>
                <button onclick="closeModal('add-teacher-modal')" class="text-gray-400 hover:text-gray-600 text-xl sm:text-2xl">&times;</button>
            </div>
            <form id="add-teacher-form" class="p-3 sm:p-4 space-y-3 sm:space-y-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" name="username" required class="w-full border rounded px-3 py-2 text-sm" placeholder="e.g., ms.santos">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" name="name" required class="w-full border rounded px-3 py-2 text-sm" placeholder="e.g., Maria Santos">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Email (optional)</label>
                    <input type="email" name="email" class="w-full border rounded px-3 py-2 text-sm" placeholder="e.g., msantos@school.edu">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" name="password" required minlength="6" class="w-full border rounded px-3 py-2 text-sm" placeholder="Min 6 characters">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Assigned Sections</label>
                    <div id="teacher-sections-checkboxes" class="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto border rounded p-2 text-sm">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('add-teacher-modal')" class="flex-1 border px-4 py-2 rounded text-sm hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" class="flex-1 bg-feu-green hover:bg-feu-green-dark text-white px-4 py-2 rounded text-sm transition-colors">Add Teacher</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="add-student-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-3 sm:p-4" role="dialog" aria-modal="true" aria-label="Add Student">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-[320px] xs:max-w-sm sm:max-w-md fade-in max-h-[90vh] overflow-y-auto">
            <div class="p-3 sm:p-4 border-b flex justify-between items-center sticky top-0 bg-white">
                <h3 class="text-base sm:text-lg font-semibold"><i class="fas fa-user-plus mr-2 text-feu-green"></i>Add New Student</h3>
                <button onclick="closeModal('add-student-modal')" class="text-gray-400 hover:text-gray-600 text-xl sm:text-2xl">&times;</button>
            </div>
            <form id="add-student-form" class="p-3 sm:p-4 space-y-3 sm:space-y-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">NFC Card ID</label>
                    <input type="text" name="nfc_id" required class="w-full border rounded px-3 py-2 text-sm" placeholder="Scan or enter NFC ID">
                </div>
                <div class="grid grid-cols-1 xs:grid-cols-2 gap-3 sm:gap-4">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">First Name</label>
                        <input type="text" name="first_name" class="w-full border rounded px-3 py-2 text-sm" placeholder="Juan">
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Last Name</label>
                        <input type="text" name="last_name" class="w-full border rounded px-3 py-2 text-sm" placeholder="Dela Cruz">
                    </div>
                </div>
                <div class="grid grid-cols-1 xs:grid-cols-2 gap-3 sm:gap-4">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Grade</label>
                        <input type="text" name="grade" class="w-full border rounded px-3 py-2 text-sm" placeholder="e.g., 11">
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Section</label>
                        <input type="text" name="section" required class="w-full border rounded px-3 py-2 text-sm" placeholder="e.g., 11-A">
                    </div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('add-student-modal')" class="flex-1 border px-4 py-2 rounded text-sm hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" class="flex-1 bg-feu-green hover:bg-feu-green-dark text-white px-4 py-2 rounded text-sm transition-colors">Add Student</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Teacher Modal -->
    <div id="edit-teacher-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-3 sm:p-4" role="dialog" aria-modal="true" aria-label="Edit Teacher">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-[320px] xs:max-w-sm sm:max-w-md fade-in max-h-[90vh] overflow-y-auto">
            <div class="p-3 sm:p-4 border-b flex justify-between items-center sticky top-0 bg-white">
                <h3 class="text-base sm:text-lg font-semibold"><i class="fas fa-user-edit mr-2 text-feu-green"></i>Edit Teacher</h3>
                <button onclick="closeModal('edit-teacher-modal')" class="text-gray-400 hover:text-gray-600 text-xl sm:text-2xl">&times;</button>
            </div>
            <form id="edit-teacher-form" class="p-3 sm:p-4 space-y-3 sm:space-y-4">
                <input type="hidden" name="id">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" name="name" required placeholder="Teacher name" class="w-full border rounded px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" name="email" placeholder="Email address" class="w-full border rounded px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">New Password (leave blank to keep)</label>
                    <input type="password" name="password" minlength="6" placeholder="Leave blank to keep" class="w-full border rounded px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Assigned Sections</label>
                    <div id="edit-teacher-sections-checkboxes" class="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto border rounded p-2 text-sm">
                    </div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('edit-teacher-modal')" class="flex-1 border px-4 py-2 rounded text-sm hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" class="flex-1 bg-feu-green hover:bg-feu-green-dark text-white px-4 py-2 rounded text-sm transition-colors">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Schedule Modal -->
    <div id="add-schedule-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-3 sm:p-4" role="dialog" aria-modal="true" aria-label="Add Schedule">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-[320px] xs:max-w-sm sm:max-w-lg fade-in max-h-[90vh] overflow-y-auto">
            <div class="p-3 sm:p-4 border-b flex justify-between items-center sticky top-0 bg-white">
                <h3 class="text-base sm:text-lg font-semibold"><i class="fas fa-calendar-plus mr-2 text-feu-green"></i>Add Section Schedule</h3>
                <button onclick="closeModal('add-schedule-modal')" class="text-gray-400 hover:text-gray-600 text-xl sm:text-2xl">&times;</button>
            </div>
            <form id="add-schedule-form" class="p-3 sm:p-4 space-y-3 sm:space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Section</label>
                        <select name="section" required class="w-full border rounded px-3 py-2 text-sm" id="add-schedule-section">
                            <option value="">Select Section</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Adviser (optional)</label>
                        <select name="adviser_id" class="w-full border rounded px-3 py-2 text-sm" id="add-schedule-adviser">
                            <option value="">No Adviser</option>
                        </select>
                    </div>
                </div>
                
                <!-- Weekly Schedule Grid -->
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">Weekly Schedule</label>
                    <div class="border rounded overflow-hidden">
                        <div class="grid grid-cols-3 gap-0 bg-gray-100 text-xs font-medium text-gray-600 text-center">
                            <div class="py-2 border-r">Day</div>
                            <div class="py-2 border-r">Start</div>
                            <div class="py-2">End</div>
                        </div>
                        <div id="add-schedule-days" class="divide-y">
                            <div class="grid grid-cols-3 gap-0 items-center"><div class="py-2 px-2 text-sm font-medium">Monday</div><input type="time" name="mon_start" value="07:00" class="border-l border-r px-2 py-2 text-sm"><input type="time" name="mon_end" value="17:00" class="px-2 py-2 text-sm"></div>
                            <div class="grid grid-cols-3 gap-0 items-center"><div class="py-2 px-2 text-sm font-medium">Tuesday</div><input type="time" name="tue_start" value="07:00" class="border-l border-r px-2 py-2 text-sm"><input type="time" name="tue_end" value="17:00" class="px-2 py-2 text-sm"></div>
                            <div class="grid grid-cols-3 gap-0 items-center"><div class="py-2 px-2 text-sm font-medium">Wednesday</div><input type="time" name="wed_start" value="07:00" class="border-l border-r px-2 py-2 text-sm"><input type="time" name="wed_end" value="17:00" class="px-2 py-2 text-sm"></div>
                            <div class="grid grid-cols-3 gap-0 items-center"><div class="py-2 px-2 text-sm font-medium">Thursday</div><input type="time" name="thu_start" value="07:00" class="border-l border-r px-2 py-2 text-sm"><input type="time" name="thu_end" value="17:00" class="px-2 py-2 text-sm"></div>
                            <div class="grid grid-cols-3 gap-0 items-center"><div class="py-2 px-2 text-sm font-medium">Friday</div><input type="time" name="fri_start" value="07:00" class="border-l border-r px-2 py-2 text-sm"><input type="time" name="fri_end" value="16:00" class="px-2 py-2 text-sm"></div>
                            <div class="grid grid-cols-3 gap-0 items-center bg-yellow-50"><div class="py-2 px-2 text-sm font-medium text-yellow-700">Saturday</div><input type="time" name="sat_start" class="border-l border-r px-2 py-2 text-sm" placeholder="None"><input type="time" name="sat_end" class="px-2 py-2 text-sm" placeholder="None"></div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Leave Saturday blank if no Saturday classes</p>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Late After (min)</label>
                        <input type="number" name="grace_period" value="20" min="0" max="120" required class="w-full border rounded px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Absent After (min)</label>
                        <input type="number" name="absent_threshold" value="60" min="1" max="300" required class="w-full border rounded px-3 py-2 text-sm">
                    </div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('add-schedule-modal')" class="flex-1 border px-4 py-2 rounded text-sm hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" class="flex-1 bg-feu-green hover:bg-feu-green-dark text-white px-4 py-2 rounded text-sm transition-colors">Add Schedule</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Schedule Modal -->
    <div id="edit-schedule-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-3 sm:p-4" role="dialog" aria-modal="true" aria-label="Edit Schedule">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-[320px] xs:max-w-sm sm:max-w-lg fade-in max-h-[90vh] overflow-y-auto">
            <div class="p-3 sm:p-4 border-b flex justify-between items-center sticky top-0 bg-white">
                <h3 class="text-base sm:text-lg font-semibold"><i class="fas fa-calendar-check mr-2 text-feu-green"></i>Edit Schedule</h3>
                <button onclick="closeModal('edit-schedule-modal')" class="text-gray-400 hover:text-gray-600 text-xl sm:text-2xl">&times;</button>
            </div>
            <form id="edit-schedule-form" class="p-3 sm:p-4 space-y-3 sm:space-y-4">
                <input type="hidden" name="section">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Section</label>
                        <input type="text" id="edit-schedule-section-display" disabled class="w-full border rounded px-3 py-2 text-sm bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Adviser</label>
                        <select name="adviser_id" class="w-full border rounded px-3 py-2 text-sm" id="edit-schedule-adviser">
                            <option value="">No Adviser</option>
                        </select>
                    </div>
                </div>
                
                <!-- Weekly Schedule Grid -->
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">Weekly Schedule</label>
                    <div class="border rounded overflow-hidden">
                        <div class="grid grid-cols-3 gap-0 bg-gray-100 text-xs font-medium text-gray-600 text-center">
                            <div class="py-2 border-r">Day</div>
                            <div class="py-2 border-r">Start</div>
                            <div class="py-2">End</div>
                        </div>
                        <div id="edit-schedule-days" class="divide-y">
                            <div class="grid grid-cols-3 gap-0 items-center"><div class="py-2 px-2 text-sm font-medium">Monday</div><input type="time" name="mon_start" class="border-l border-r px-2 py-2 text-sm"><input type="time" name="mon_end" class="px-2 py-2 text-sm"></div>
                            <div class="grid grid-cols-3 gap-0 items-center"><div class="py-2 px-2 text-sm font-medium">Tuesday</div><input type="time" name="tue_start" class="border-l border-r px-2 py-2 text-sm"><input type="time" name="tue_end" class="px-2 py-2 text-sm"></div>
                            <div class="grid grid-cols-3 gap-0 items-center"><div class="py-2 px-2 text-sm font-medium">Wednesday</div><input type="time" name="wed_start" class="border-l border-r px-2 py-2 text-sm"><input type="time" name="wed_end" class="px-2 py-2 text-sm"></div>
                            <div class="grid grid-cols-3 gap-0 items-center"><div class="py-2 px-2 text-sm font-medium">Thursday</div><input type="time" name="thu_start" class="border-l border-r px-2 py-2 text-sm"><input type="time" name="thu_end" class="px-2 py-2 text-sm"></div>
                            <div class="grid grid-cols-3 gap-0 items-center"><div class="py-2 px-2 text-sm font-medium">Friday</div><input type="time" name="fri_start" class="border-l border-r px-2 py-2 text-sm"><input type="time" name="fri_end" class="px-2 py-2 text-sm"></div>
                            <div class="grid grid-cols-3 gap-0 items-center bg-yellow-50"><div class="py-2 px-2 text-sm font-medium text-yellow-700">Saturday</div><input type="time" name="sat_start" class="border-l border-r px-2 py-2 text-sm"><input type="time" name="sat_end" class="px-2 py-2 text-sm"></div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Leave Saturday blank if no Saturday classes</p>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Late After (min)</label>
                        <input type="number" name="grace_period" min="0" max="120" required class="w-full border rounded px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Absent After (min)</label>
                        <input type="number" name="absent_threshold" min="1" max="300" required class="w-full border rounded px-3 py-2 text-sm">
                    </div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('edit-schedule-modal')" class="flex-1 border px-4 py-2 rounded text-sm hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" class="flex-1 bg-feu-green hover:bg-feu-green-dark text-white px-4 py-2 rounded text-sm transition-colors">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-feu-green-dark text-white pt-12 pb-6 px-4 sm:px-6 lg:px-8 mt-auto">
        <div class="max-w-6xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 lg:gap-12 mb-8">
                <!-- Brand -->
                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <img src="/assets/TamTap-3D.png" alt="TAMTAP" class="h-10 w-10 object-contain">
                        <span class="font-brand text-xl font-bold">
                            <span class="text-white">TAM</span><span class="text-feu-gold">TAP</span>
                        </span>
                    </div>
                    <p class="text-white text-sm leading-relaxed">
                        NFC-Based Attendance System<br>
                        FEU Roosevelt Marikina<br>
                        Grade 12 ICT B Capstone Project
                    </p>
                </div>
                <!-- Quick Links -->
                <div>
                    <h4 class="text-feu-gold font-semibold text-sm uppercase tracking-wide mb-3">Quick Links</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="/privacy" class="text-white hover:text-feu-gold transition"><i class="fas fa-shield-halved mr-1.5 text-xs"></i>Privacy Policy</a></li>
                        <li><a href="/terms" class="text-white hover:text-feu-gold transition"><i class="fas fa-file-contract mr-1.5 text-xs"></i>Terms of Use</a></li>
                        <li><a href="/researchers" class="text-white hover:text-feu-gold transition"><i class="fas fa-flask mr-1.5 text-xs"></i>Researchers</a></li>
                        <li><a href="/dashboard" class="text-white hover:text-feu-gold transition"><i class="fas fa-chart-line mr-1.5 text-xs"></i>Dashboard</a></li>
                    </ul>
                </div>
                <!-- Contact -->
                <div>
                    <h4 class="text-feu-gold font-semibold text-sm uppercase tracking-wide mb-3">School</h4>
                    <ul class="space-y-2 text-sm text-white">
                        <li class="flex items-start gap-2">
                            <i class="fas fa-school mt-0.5 text-xs text-feu-gold"></i>
                            <span>FEU Roosevelt  Marikina Campus</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-map-marker-alt mt-0.5 text-xs text-feu-gold"></i>
                            <span>J.P. Rizal St., Lamuan, Marikina City</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-globe mt-0.5 text-xs text-feu-gold"></i>
                            <a href="https://feuroosevelt.edu.ph" target="_blank" rel="noopener" class="text-white hover:text-feu-gold transition">feuroosevelt.edu.ph</a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- Divider -->
            <div class="border-t border-white/15 pt-5">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-2 text-xs text-white">
                    <p>&copy; 2025</p>
                    <p>Capstone by Group 5 of Grade 12 ICT B &nbsp;|&nbsp; FEU Roosevelt Marikina</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        let currentUser = null;
        let allSections = [];

        // ========================================
        // AUTH CHECK
        // ========================================
        async function checkAuth() {
            try {
                const res = await fetch('/api/auth/me', { credentials: 'include' });
                if (!res.ok) {
                    window.location.replace('/login');
                    return;
                }
                const data = await res.json();
                if (!data.success || data.user.role !== 'admin') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Access Denied',
                        text: 'Admin access required',
                        confirmButtonColor: '#0a8249'
                    }).then(() => {
                        window.location.replace('/dashboard');
                    });
                    return;
                }
                currentUser = data.user;
                
                // Auth verified - show page content
                document.body.classList.remove('auth-loading');
                
                // Update UI with user info
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('menu-user-name').textContent = currentUser.name;
                document.getElementById('menu-user-role').textContent = 'System Administrator';
                
                loadData();
            } catch (e) {
                window.location.replace('/login');
            }
        }

        async function logout() {
            showPreloader('Logging out...');
            await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
            navigateTo('/login', 'Redirecting to login...');
        }

        // ========================================
        // SETTINGS MENU
        // ========================================
        function toggleSettingsMenu() {
            const menu = document.getElementById('settings-menu');
            menu.classList.toggle('hidden');
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('settings-menu');
            const btn = e.target.closest('button[onclick="toggleSettingsMenu()"]');
            if (!btn && !menu.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        function showPersonalInfo() {
            document.getElementById('settings-menu').classList.add('hidden');
            Swal.fire({
                title: 'Personal Information',
                html: `
                    <div class="text-left space-y-3">
                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                            <div class="w-12 h-12 bg-feu-gold rounded-full flex items-center justify-center text-feu-green-dark">
                                <i class="fas fa-user-shield text-xl"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800">${currentUser?.name || 'Admin'}</p>
                                <p class="text-sm text-gray-500">System Administrator</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <p><strong>Username:</strong> ${currentUser?.username || 'admin'}</p>
                            <p><strong>Email:</strong> ${currentUser?.email || 'N/A'}</p>
                            <p><strong>Role:</strong> Administrator</p>
                        </div>
                    </div>
                `,
                confirmButtonColor: '#0a8249',
                confirmButtonText: 'Close'
            });
        }

        // ========================================
        // TAB NAVIGATION
        // ========================================
        function showTab(tabName) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
            
            document.getElementById(`panel-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
        }

        // ========================================
        // DATA LOADING
        // ========================================
        async function loadData() {
            await loadSections();
            loadTeachers();
            loadStudents();
            loadSchedules();
        }

        async function loadSections() {
            try {
                const res = await fetch('/api/admin/sections', { credentials: 'include' });
                const data = await res.json();
                
                // Hide skeleton, show grid
                document.getElementById('sections-grid-skeleton').classList.add('hidden');
                document.getElementById('sections-grid').classList.remove('hidden');
                
                if (data.success) {
                    allSections = data.data;
                    
                    // Update section filter dropdown
                    const filter = document.getElementById('student-section-filter');
                    filter.innerHTML = '<option value="">All Sections</option>' + 
                        allSections.map(s => `<option value="${s.name}">${s.name} (${s.studentCount})</option>`).join('');
                    
                    // Update sections grid
                    const grid = document.getElementById('sections-grid');
                    if (allSections.length === 0) {
                        grid.innerHTML = '<p class="text-gray-400">No sections found. Add students to create sections.</p>';
                    } else {
                        grid.innerHTML = allSections.map(s => `
                            <div class="bg-gradient-to-br from-feu-green/5 to-feu-green/10 rounded-lg p-4 border border-feu-green/20 hover:shadow-md transition-shadow">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-users text-feu-green"></i>
                                    <h3 class="font-semibold text-base sm:text-lg text-gray-800">${s.name}</h3>
                                </div>
                                <p class="text-gray-500 text-sm">${s.studentCount} student${s.studentCount !== 1 ? 's' : ''}</p>
                            </div>
                        `).join('');
                    }
                    
                    // Update teacher section checkboxes
                    updateSectionCheckboxes();
                }
            } catch (e) {
                console.error('Load sections error:', e);
            }
        }

        function updateSectionCheckboxes() {
            const html = allSections.map(s => `
                <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" name="sections" value="${s.name}">
                    ${s.name}
                </label>
            `).join('');
            
            document.getElementById('teacher-sections-checkboxes').innerHTML = html || '<p class="text-gray-400 text-sm">No sections available</p>';
            document.getElementById('edit-teacher-sections-checkboxes').innerHTML = html || '<p class="text-gray-400 text-sm">No sections available</p>';
        }

        async function loadTeachers() {
            try {
                const res = await fetch('/api/admin/teachers', { credentials: 'include' });
                const data = await res.json();
                
                // Hide skeleton, show table
                document.getElementById('teachers-table-skeleton').classList.add('hidden');
                document.getElementById('teachers-table').classList.remove('hidden');
                document.getElementById('teachers-cards-skeleton').classList.add('hidden');
                document.getElementById('teachers-cards').classList.remove('hidden');
                
                const tbody = document.getElementById('teachers-table');
                
                if (!data.success || data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">No teachers found</td></tr>';
                    document.getElementById('teachers-cards').innerHTML = '<p class="text-center text-gray-400 py-4">No teachers found</p>';
                    return;
                }
                
                // Desktop table
                tbody.innerHTML = data.data.map(t => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 lg:px-4 py-3 text-sm font-medium text-gray-900">${t.username}</td>
                        <td class="px-3 lg:px-4 py-3 text-sm text-gray-700">${t.name}</td>
                        <td class="px-3 lg:px-4 py-3 text-sm text-gray-500 hidden md:table-cell">${t.email || '-'}</td>
                        <td class="px-3 lg:px-4 py-3 text-sm">
                            ${t.sections_handled.length > 0 
                                ? t.sections_handled.map(s => `<span class="inline-block bg-feu-green/10 text-feu-green px-2 py-0.5 rounded text-xs mr-1 mb-1">${s}</span>`).join('')
                                : '<span class="text-gray-400">None</span>'
                            }
                        </td>
                        <td class="px-3 lg:px-4 py-3 text-sm">
                            <button onclick="editTeacher('${t.id}')" class="text-feu-green hover:text-feu-green-dark mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteTeacher('${t.id}', '${t.name}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
                
                // Mobile cards
                document.getElementById('teachers-cards').innerHTML = data.data.map(t => `
                    <div class="bg-gray-50 rounded-lg p-3 border">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="font-semibold text-gray-900">${t.name}</p>
                                <p class="text-xs text-gray-500">@${t.username}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editTeacher('${t.id}')" class="text-feu-green hover:text-feu-green-dark p-1"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteTeacher('${t.id}', '${t.name}')" class="text-red-600 hover:text-red-800 p-1"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        ${t.email ? `<p class="text-xs text-gray-500 mb-2"><i class="fas fa-envelope mr-1"></i>${t.email}</p>` : ''}
                        <div class="flex flex-wrap gap-1">
                            ${t.sections_handled.length > 0 
                                ? t.sections_handled.map(s => `<span class="bg-feu-green/10 text-feu-green px-2 py-0.5 rounded text-xs">${s}</span>`).join('')
                                : '<span class="text-gray-400 text-xs">No sections</span>'
                            }
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Load teachers error:', e);
            }
        }

        async function loadStudents() {
            try {
                const section = document.getElementById('student-section-filter').value;
                const url = section ? `/api/admin/students?section=${encodeURIComponent(section)}` : '/api/admin/students';
                
                const res = await fetch(url, { credentials: 'include' });
                const data = await res.json();
                
                // Hide skeleton, show table
                document.getElementById('students-table-skeleton').classList.add('hidden');
                document.getElementById('students-table').classList.remove('hidden');
                document.getElementById('students-cards-skeleton').classList.add('hidden');
                document.getElementById('students-cards').classList.remove('hidden');
                
                const tbody = document.getElementById('students-table');
                
                if (!data.success || data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No students found</td></tr>';
                    document.getElementById('students-cards').innerHTML = '<p class="text-center text-gray-400 py-4">No students found</p>';
                    return;
                }
                
                // Desktop table
                tbody.innerHTML = data.data.map(s => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 lg:px-4 py-3 text-sm font-medium text-gray-900">${s.tamtap_id}</td>
                        <td class="px-3 lg:px-4 py-3 text-sm text-gray-500 font-mono hidden lg:table-cell">${s.nfc_id}</td>
                        <td class="px-3 lg:px-4 py-3 text-sm text-gray-700">${s.name}</td>
                        <td class="px-3 lg:px-4 py-3 text-sm text-gray-500 hidden md:table-cell">${s.grade || '-'}</td>
                        <td class="px-3 lg:px-4 py-3 text-sm">
                            <span class="bg-feu-green/10 text-feu-green px-2 py-0.5 rounded text-xs">${s.section}</span>
                        </td>
                        <td class="px-3 lg:px-4 py-3 text-sm">
                            <button onclick="deleteStudent('${s.nfc_id}', '${s.name}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
                
                // Mobile cards
                document.getElementById('students-cards').innerHTML = data.data.map(s => `
                    <div class="bg-gray-50 rounded-lg p-3 border">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-900">${s.name}</p>
                                <p class="text-xs text-gray-500">ID: ${s.tamtap_id}</p>
                                <p class="text-xs text-gray-400 font-mono mt-1">NFC: ${s.nfc_id}</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="bg-feu-green/10 text-feu-green px-2 py-0.5 rounded text-xs">${s.section}</span>
                                <button onclick="deleteStudent('${s.nfc_id}', '${s.name}')" class="text-red-600 hover:text-red-800 p-1"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Load students error:', e);
            }
        }

        // ========================================
        // SCHEDULES
        // ========================================
        let allSchedules = [];
        let allTeachers = [];

        async function loadSchedules() {
            try {
                // Load schedules
                const res = await fetch('/api/schedules', { credentials: 'include' });
                const data = await res.json();
                
                // Load teachers for adviser dropdown
                const teachersRes = await fetch('/api/admin/teachers', { credentials: 'include' });
                const teachersData = await teachersRes.json();
                if (teachersData.success) {
                    allTeachers = teachersData.data;
                }
                
                // Hide skeleton, show table
                document.getElementById('schedules-table-skeleton').classList.add('hidden');
                document.getElementById('schedules-table').classList.remove('hidden');
                document.getElementById('schedules-mobile-skeleton').classList.add('hidden');
                document.getElementById('schedules-mobile').classList.remove('hidden');
                
                if (data.success) {
                    allSchedules = data.data;
                    renderSchedules();
                }
            } catch (e) {
                console.error('Load schedules error:', e);
            }
        }

        function renderSchedules() {
            const tbody = document.getElementById('schedules-table');
            const mobile = document.getElementById('schedules-mobile');
            
            if (allSchedules.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No schedules configured. Click "Add" to create one.</td></tr>';
                mobile.innerHTML = '<div class="text-center text-gray-400 py-6">No schedules configured</div>';
                return;
            }
            
            // Helper to format weekly schedule summary
            function getScheduleSummary(ws) {
                if (!ws) return { weekday: '07:00-17:00', sat: 'None' };
                const mon = ws.monday || { start: '07:00', end: '17:00' };
                const sat = ws.saturday || {};
                return {
                    weekday: `${mon.start || '07:00'}-${mon.end || '17:00'}`,
                    sat: sat.start ? `${sat.start}-${sat.end}` : 'None'
                };
            }
            
            // Desktop table
            tbody.innerHTML = allSchedules.map(s => {
                const adviser = allTeachers.find(t => t._id === s.adviser_id);
                const summary = getScheduleSummary(s.weekly_schedule);
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 lg:px-4 py-3">
                            <span class="inline-flex items-center gap-1.5">
                                <i class="fas fa-users text-feu-green text-xs"></i>
                                <span class="font-medium">${s.section}</span>
                            </span>
                        </td>
                        <td class="px-3 lg:px-4 py-3 text-gray-600">${adviser ? adviser.name : '<span class="text-gray-400"></span>'}</td>
                        <td class="px-3 lg:px-4 py-3 font-mono text-sm">${summary.weekday}</td>
                        <td class="px-3 lg:px-4 py-3 font-mono text-sm ${summary.sat === 'None' ? 'text-gray-400' : 'text-yellow-600'}">${summary.sat}</td>
                        <td class="px-3 lg:px-4 py-3">${s.grace_period_minutes || 20} min</td>
                        <td class="px-3 lg:px-4 py-3">
                            <div class="flex items-center gap-1">
                                <button onclick="editSchedule('${s.section}')" class="text-blue-600 hover:text-blue-800 p-1.5" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteSchedule('${s.section}')" class="text-red-600 hover:text-red-800 p-1.5" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Mobile cards
            mobile.innerHTML = allSchedules.map(s => {
                const adviser = allTeachers.find(t => t._id === s.adviser_id);
                const summary = getScheduleSummary(s.weekly_schedule);
                return `
                    <div class="border rounded-lg p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-semibold text-gray-800">${s.section}</h4>
                                <p class="text-xs text-gray-500">${adviser ? adviser.name : 'No adviser'}</p>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="editSchedule('${s.section}')" class="text-blue-600 p-1"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteSchedule('${s.section}')" class="text-red-600 p-1"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-xs text-gray-600">
                            <div><span class="text-gray-400">M-F:</span> ${summary.weekday}</div>
                            <div><span class="text-gray-400">Sat:</span> ${summary.sat}</div>
                            <div><span class="text-gray-400">Grace:</span> ${s.grace_period_minutes || 20}m</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddScheduleModal() {
            document.getElementById('add-schedule-form').reset();
            
            // Populate section dropdown (exclude already configured)
            const configuredSections = allSchedules.map(s => s.section);
            const availableSections = allSections.filter(s => !configuredSections.includes(s.name));
            const sectionSelect = document.getElementById('add-schedule-section');
            sectionSelect.innerHTML = '<option value="">Select Section</option>' + 
                availableSections.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            
            // Populate adviser dropdown
            populateAdviserDropdown('add-schedule-adviser');
            
            showModal('add-schedule-modal');
        }

        function populateAdviserDropdown(elementId, selectedId = '') {
            const select = document.getElementById(elementId);
            select.innerHTML = '<option value="">No Adviser</option>' + 
                allTeachers.map(t => `<option value="${t._id}" ${t._id === selectedId ? 'selected' : ''}>${t.name}</option>`).join('');
        }

        function editSchedule(section) {
            const schedule = allSchedules.find(s => s.section === section);
            if (!schedule) return;
            
            const form = document.getElementById('edit-schedule-form');
            form.querySelector('input[name="section"]').value = schedule.section;
            document.getElementById('edit-schedule-section-display').value = schedule.section;
            form.querySelector('input[name="grace_period"]').value = schedule.grace_period_minutes || 20;
            form.querySelector('input[name="absent_threshold"]').value = schedule.absent_threshold_minutes || 60;
            
            // Populate weekly schedule
            const ws = schedule.weekly_schedule || {};
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            days.forEach((d, i) => {
                const dayData = ws[dayNames[i]] || {};
                form.querySelector(`input[name="${d}_start"]`).value = dayData.start || (d === 'sat' ? '' : '07:00');
                form.querySelector(`input[name="${d}_end"]`).value = dayData.end || (d === 'sat' ? '' : '17:00');
            });
            
            populateAdviserDropdown('edit-schedule-adviser', schedule.adviser_id || '');
            
            showModal('edit-schedule-modal');
        }

        async function deleteSchedule(section) {
            const result = await Swal.fire({
                title: 'Delete Schedule?',
                text: `This will remove the schedule for ${section}`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Delete',
                confirmButtonColor: '#dc2626'
            });
            
            if (!result.isConfirmed) return;
            
            try {
                const res = await fetch(`/api/schedules/${encodeURIComponent(section)}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const data = await res.json();
                
                if (data.success) {
                    Swal.fire({ icon: 'success', title: 'Deleted', text: 'Schedule removed', timer: 1500, showConfirmButton: false });
                    loadSchedules();
                } else {
                    throw new Error(data.error);
                }
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'Error', text: e.message, confirmButtonColor: '#0a8249' });
            }
        }

        function downloadScheduleTemplate() {
            // CSV headers matching the import format
            const headers = ['Section', 'Grade', 'Adviser Name', 'Mon Start', 'Mon End', 'Tue Start', 'Tue End', 'Wed Start', 'Wed End', 'Thu Start', 'Thu End', 'Fri Start', 'Fri End', 'Sat Start', 'Sat End'];
            
            // Example rows
            const rows = [
                ['ICT-A', '12', 'Juan Dela Cruz', '07:00', '17:00', '07:00', '17:00', '07:00', '17:00', '07:00', '17:00', '07:00', '16:00', '', ''],
                ['ICT-B', '12', 'Maria Santos', '08:00', '17:00', '08:00', '17:00', '08:00', '17:00', '08:00', '17:00', '08:00', '16:00', '08:00', '12:00'],
                ['STEM-A', '11', '', '07:30', '16:00', '07:30', '16:00', '07:30', '16:00', '07:30', '16:00', '07:30', '15:00', '', '']
            ];
            
            // Build CSV content
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.join(',') + '\n';
            });
            
            // Create download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'schedule-import-template.csv';
            link.click();
            URL.revokeObjectURL(link.href);
            
            Swal.fire({
                icon: 'info',
                title: 'Template Downloaded',
                html: '<p class="text-sm text-gray-600">Open in Excel, edit your sections, then save as <strong>.xlsx</strong> before importing.</p><p class="text-xs text-gray-500 mt-2">Leave Sat Start/End blank for no Saturday classes.</p>',
                confirmButtonColor: '#0a8249'
            });
        }

        async function importScheduleXLSX() {
            const input = document.getElementById('schedule-xlsx-input');
            if (!input.files.length) return;
            
            const formData = new FormData();
            formData.append('file', input.files[0]);
            
            try {
                Swal.fire({ title: 'Importing...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                const res = await fetch('/api/schedules/import', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                const data = await res.json();
                
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Import Complete',
                        text: `${data.imported} schedules imported, ${data.skipped} skipped`,
                        confirmButtonColor: '#0a8249'
                    });
                    loadSchedules();
                } else {
                    throw new Error(data.error);
                }
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'Import Failed', text: e.message, confirmButtonColor: '#0a8249' });
            }
            
            input.value = '';
        }

        // Add Schedule Form
        document.getElementById('add-schedule-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            
            // Build weekly_schedule object
            const weekly_schedule = {
                monday:    { start: form.mon_start.value || '07:00', end: form.mon_end.value || '17:00' },
                tuesday:   { start: form.tue_start.value || '07:00', end: form.tue_end.value || '17:00' },
                wednesday: { start: form.wed_start.value || '07:00', end: form.wed_end.value || '17:00' },
                thursday:  { start: form.thu_start.value || '07:00', end: form.thu_end.value || '17:00' },
                friday:    { start: form.fri_start.value || '07:00', end: form.fri_end.value || '17:00' },
                saturday:  { start: form.sat_start.value || null, end: form.sat_end.value || null }
            };
            
            const payload = {
                section: form.section.value,
                adviser_id: form.adviser_id.value || null,
                weekly_schedule,
                grace_period_minutes: parseInt(form.grace_period.value),
                absent_threshold_minutes: parseInt(form.absent_threshold.value)
            };
            
            try {
                const res = await fetch('/api/schedules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if (data.success) {
                    Swal.fire({ icon: 'success', title: 'Added', text: 'Schedule created', timer: 1500, showConfirmButton: false });
                    closeModal('add-schedule-modal');
                    loadSchedules();
                } else {
                    throw new Error(data.error);
                }
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'Error', text: e.message, confirmButtonColor: '#0a8249' });
            }
        });

        // Edit Schedule Form
        document.getElementById('edit-schedule-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const section = form.section.value;
            
            // Build weekly_schedule object
            const weekly_schedule = {
                monday:    { start: form.mon_start.value || '07:00', end: form.mon_end.value || '17:00' },
                tuesday:   { start: form.tue_start.value || '07:00', end: form.tue_end.value || '17:00' },
                wednesday: { start: form.wed_start.value || '07:00', end: form.wed_end.value || '17:00' },
                thursday:  { start: form.thu_start.value || '07:00', end: form.thu_end.value || '17:00' },
                friday:    { start: form.fri_start.value || '07:00', end: form.fri_end.value || '17:00' },
                saturday:  { start: form.sat_start.value || null, end: form.sat_end.value || null }
            };
            
            const payload = {
                adviser_id: form.adviser_id.value || null,
                weekly_schedule,
                grace_period_minutes: parseInt(form.grace_period.value),
                absent_threshold_minutes: parseInt(form.absent_threshold.value)
            };
            
            try {
                const res = await fetch(`/api/schedules/${encodeURIComponent(section)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if (data.success) {
                    Swal.fire({ icon: 'success', title: 'Updated', text: 'Schedule updated', timer: 1500, showConfirmButton: false });
                    closeModal('edit-schedule-modal');
                    loadSchedules();
                } else {
                    throw new Error(data.error);
                }
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'Error', text: e.message, confirmButtonColor: '#0a8249' });
            }
        });

        // ========================================
        // MODALS
        // ========================================
        function showModal(id) {
            document.getElementById(id).classList.remove('hidden');
            document.getElementById(id).classList.add('flex');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        }

        function showAddTeacherModal() {
            document.getElementById('add-teacher-form').reset();
            showModal('add-teacher-modal');
        }

        function showAddStudentModal() {
            document.getElementById('add-student-form').reset();
            showModal('add-student-modal');
        }

        // ========================================
        // TEACHER CRUD
        // ========================================
        document.getElementById('add-teacher-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const sections = Array.from(form.querySelectorAll('input[name="sections"]:checked')).map(cb => cb.value);
            
            try {
                const res = await fetch('/api/admin/teachers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: form.username.value,
                        name: form.name.value,
                        email: form.email.value,
                        password: form.password.value,
                        sections_handled: sections
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    Swal.fire({ icon: 'success', title: 'Teacher Added', timer: 1500, showConfirmButton: false });
                    closeModal('add-teacher-modal');
                    loadTeachers();
                } else {
                    Swal.fire({ icon: 'error', title: 'Error', text: data.error, confirmButtonColor: '#0a8249' });
                }
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to add teacher', confirmButtonColor: '#0a8249' });
            }
        });

        async function editTeacher(id) {
            try {
                const res = await fetch('/api/admin/teachers', { credentials: 'include' });
                const data = await res.json();
                const teacher = data.data.find(t => t.id === id);
                
                if (!teacher) return;
                
                const form = document.getElementById('edit-teacher-form');
                form.id.value = id;
                form.name.value = teacher.name;
                form.email.value = teacher.email || '';
                form.password.value = '';
                
                // Check assigned sections
                form.querySelectorAll('input[name="sections"]').forEach(cb => {
                    cb.checked = teacher.sections_handled.includes(cb.value);
                });
                
                showModal('edit-teacher-modal');
            } catch (e) {
                console.error('Edit teacher error:', e);
            }
        }

        document.getElementById('edit-teacher-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.id.value;
            const sections = Array.from(form.querySelectorAll('input[name="sections"]:checked')).map(cb => cb.value);
            
            const updateData = {
                name: form.name.value,
                email: form.email.value,
                sections_handled: sections
            };
            
            if (form.password.value) {
                updateData.password = form.password.value;
            }
            
            try {
                const res = await fetch(`/api/admin/teachers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(updateData)
                });
                
                const data = await res.json();
                
                if (data.success) {
                    Swal.fire({ icon: 'success', title: 'Teacher Updated', timer: 1500, showConfirmButton: false });
                    closeModal('edit-teacher-modal');
                    loadTeachers();
                } else {
                    Swal.fire({ icon: 'error', title: 'Error', text: data.error, confirmButtonColor: '#0a8249' });
                }
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to update teacher', confirmButtonColor: '#0a8249' });
            }
        });

        async function deleteTeacher(id, name) {
            const result = await Swal.fire({
                title: 'Delete Teacher?',
                text: `Remove ${name}'s account?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Delete'
            });
            
            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/api/admin/teachers/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    
                    if (res.ok) {
                        Swal.fire({ icon: 'success', title: 'Deleted', timer: 1500, showConfirmButton: false });
                        loadTeachers();
                    }
                } catch (e) {
                    Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to delete', confirmButtonColor: '#0a8249' });
                }
            }
        }

        // ========================================
        // STUDENT CRUD
        // ========================================
        document.getElementById('add-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            
            try {
                const res = await fetch('/api/admin/students', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        nfc_id: form.nfc_id.value,
                        first_name: form.first_name.value,
                        last_name: form.last_name.value,
                        grade: form.grade.value,
                        section: form.section.value
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    Swal.fire({ icon: 'success', title: 'Student Added', text: `ID: ${data.data.tamtap_id}`, timer: 2000, showConfirmButton: false });
                    closeModal('add-student-modal');
                    loadStudents();
                    loadSections();
                } else {
                    Swal.fire({ icon: 'error', title: 'Error', text: data.error, confirmButtonColor: '#0a8249' });
                }
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to add student', confirmButtonColor: '#0a8249' });
            }
        });

        async function deleteStudent(nfcId, name) {
            const result = await Swal.fire({
                title: 'Delete Student?',
                text: `Remove ${name}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Delete'
            });
            
            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/api/admin/students/${nfcId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    
                    if (res.ok) {
                        Swal.fire({ icon: 'success', title: 'Deleted', timer: 1500, showConfirmButton: false });
                        loadStudents();
                        loadSections();
                    }
                } catch (e) {
                    Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to delete', confirmButtonColor: '#0a8249' });
                }
            }
        }

        function showBulkImportModal() {
            Swal.fire({
                title: 'Bulk Import Students',
                html: `
                    <p class="text-sm text-gray-600 mb-4">Paste CSV data (nfc_id, first_name, last_name, grade, section)</p>
                    <textarea id="csv-data" class="w-full border rounded p-2 h-32 text-sm font-mono" placeholder="04A1B2C3,Juan,Dela Cruz,11,11-A
04D5E6F7,Maria,Santos,11,11-A"></textarea>
                `,
                showCancelButton: true,
                confirmButtonText: 'Import',
                confirmButtonColor: '#0a8249',
                cancelButtonColor: '#6b7280',
                preConfirm: () => {
                    const csv = document.getElementById('csv-data').value;
                    return parseCSV(csv);
                }
            }).then(async (result) => {
                if (result.isConfirmed && result.value.length > 0) {
                    try {
                        const res = await fetch('/api/admin/students/bulk', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ students: result.value })
                        });
                        
                        const data = await res.json();
                        
                        Swal.fire({
                            icon: data.results.failed > 0 ? 'warning' : 'success',
                            title: 'Import Complete',
                            html: `<p>Success: ${data.results.success}</p><p>Failed: ${data.results.failed}</p>`,
                            confirmButtonColor: '#0a8249'
                        });
                        
                        loadStudents();
                        loadSections();
                    } catch (e) {
                        Swal.fire({ icon: 'error', title: 'Import Failed', confirmButtonColor: '#0a8249' });
                    }
                }
            });
        }

        function parseCSV(csv) {
            return csv.trim().split('\n').map(line => {
                const [nfc_id, first_name, last_name, grade, section] = line.split(',').map(s => s.trim());
                return { nfc_id, first_name, last_name, grade, section };
            }).filter(s => s.nfc_id && s.section);
        }

        // ========================================
        // SYSTEM LOGS CONSOLE
        // ========================================
        let logSocket = null;
        let isStreamingLogs = false;
        const MAX_LOG_LINES = 200;
        
        const LOG_COLORS = {
            'info': 'text-green-400',
            'notice': 'text-green-300',
            'warn': 'text-yellow-400',
            'warning': 'text-yellow-400',
            'error': 'text-red-400',
            'crit': 'text-red-500',
            'alert': 'text-red-600',
            'emerg': 'text-red-700',
            'debug': 'text-cyan-400'
        };
        
        const SERVICE_CONSOLES = {
            'buttons': 'console-buttons',
            'hardware': 'console-hardware',
            'server': 'console-server'
        };
        
        function getLogColor(level) {
            return LOG_COLORS[level] || 'text-gray-300';
        }
        
        function formatLogEntry(entry) {
            const time = new Date(entry.timestamp).toLocaleTimeString('en-US', { hour12: false });
            const colorClass = getLogColor(entry.level);
            const levelBadge = entry.level ? `<span class="text-gray-500">[${entry.level.toUpperCase().padEnd(5)}]</span>` : '';
            return `<div class="${colorClass}"><span class="text-gray-600">${time}</span> ${levelBadge} ${escapeHtml(entry.message)}</div>`;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function appendLog(service, entry) {
            const consoleEl = document.getElementById(SERVICE_CONSOLES[service]);
            if (!consoleEl) return;
            
            // Create log line
            const logLine = document.createElement('div');
            logLine.className = getLogColor(entry.level);
            const time = new Date(entry.timestamp).toLocaleTimeString('en-US', { hour12: false });
            logLine.innerHTML = `<span class="text-gray-600">${time}</span> ${escapeHtml(entry.message)}`;
            
            consoleEl.appendChild(logLine);
            
            // Trim old logs
            while (consoleEl.children.length > MAX_LOG_LINES) {
                consoleEl.removeChild(consoleEl.firstChild);
            }
            
            // Auto-scroll to bottom
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }
        
        function clearAllLogs() {
            Object.values(SERVICE_CONSOLES).forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = '<div class="text-gray-500">// Console cleared</div>';
                }
            });
        }
        
        async function refreshLogs() {
            try {
                const res = await fetch('/api/logs?lines=50', { credentials: 'include' });
                if (!res.ok) throw new Error('Failed to fetch logs');
                
                const data = await res.json();
                
                if (data.success && data.logs) {
                    // Clear and populate each console
                    Object.entries(data.logs).forEach(([service, logs]) => {
                        const consoleEl = document.getElementById(SERVICE_CONSOLES[service]);
                        if (consoleEl) {
                            consoleEl.innerHTML = logs.map(entry => formatLogEntry(entry)).join('');
                            consoleEl.scrollTop = consoleEl.scrollHeight;
                        }
                    });
                }
            } catch (e) {
                console.error('Failed to refresh logs:', e);
                Swal.fire({
                    icon: 'warning',
                    title: 'Logs Unavailable',
                    text: 'journalctl not available. Deploy to Raspberry Pi for live logs.',
                    confirmButtonColor: '#0a8249'
                });
            }
        }
        
        function toggleLogStream() {
            if (isStreamingLogs) {
                stopLogStream();
            } else {
                startLogStream();
            }
        }
        
        function startLogStream() {
            if (isStreamingLogs) return;
            
            // Connect to Socket.IO for live logs
            if (typeof io === 'undefined') {
                // Load Socket.IO if not already loaded
                const script = document.createElement('script');
                script.src = '/socket.io/socket.io.js';
                script.onload = () => initLogSocket();
                document.head.appendChild(script);
            } else {
                initLogSocket();
            }
        }
        
        function initLogSocket() {
            logSocket = io();
            
            logSocket.on('connect', () => {
                isStreamingLogs = true;
                updateStreamUI(true);
                
                // Subscribe to all service logs
                logSocket.emit('logs:subscribe', ['buttons', 'hardware', 'server']);
                
                // Update status indicators
                updateServiceStatus('buttons', 'streaming');
                updateServiceStatus('hardware', 'streaming');
                updateServiceStatus('server', 'streaming');
            });
            
            logSocket.on('connect_error', (err) => {
                // Show connection errors in all console panes
                ['buttons', 'hardware', 'server'].forEach(svc => {
                    appendLog(svc, {
                        timestamp: new Date().toISOString(),
                        message: `Socket connection failed: ${err.message}`,
                        level: 'error'
                    });
                });
                isStreamingLogs = false;
                updateStreamUI(false);
            });
            
            logSocket.on('logs:entry', (entry) => {
                appendLog(entry.service, entry);
            });
            
            logSocket.on('logs:error', (data) => {
                appendLog(data.service, {
                    timestamp: new Date().toISOString(),
                    message: `ERROR: ${data.error}`,
                    level: 'error'
                });
            });
            
            logSocket.on('disconnect', () => {
                isStreamingLogs = false;
                updateStreamUI(false);
                updateServiceStatus('buttons', 'disconnected');
                updateServiceStatus('hardware', 'disconnected');
                updateServiceStatus('server', 'disconnected');
            });
        }
        
        function stopLogStream() {
            if (logSocket) {
                logSocket.emit('logs:unsubscribe');
                logSocket.disconnect();
                logSocket = null;
            }
            isStreamingLogs = false;
            updateStreamUI(false);
            updateServiceStatus('buttons', 'idle');
            updateServiceStatus('hardware', 'idle');
            updateServiceStatus('server', 'idle');
        }
        
        function updateStreamUI(isActive) {
            const btn = document.getElementById('btn-stream-toggle');
            const status = document.getElementById('logs-status');
            
            if (isActive) {
                btn.innerHTML = '<i class="fas fa-stop mr-1"></i><span>Stop Live</span>';
                btn.classList.remove('bg-feu-green', 'hover:bg-feu-green-dark');
                btn.classList.add('bg-red-500', 'hover:bg-red-600');
                status.innerHTML = '<i class="fas fa-circle text-green-500 mr-1 animate-pulse"></i>Live';
                status.classList.remove('bg-gray-100', 'text-gray-500');
                status.classList.add('bg-green-100', 'text-green-700');
            } else {
                btn.innerHTML = '<i class="fas fa-play mr-1"></i><span>Start Live</span>';
                btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                btn.classList.add('bg-feu-green', 'hover:bg-feu-green-dark');
                status.innerHTML = '<i class="fas fa-circle text-gray-500 mr-1"></i>Disconnected';
                status.classList.remove('bg-green-100', 'text-green-700');
                status.classList.add('bg-gray-100', 'text-gray-500');
            }
        }
        
        function updateServiceStatus(service, state) {
            const statusEl = document.getElementById(`status-${service}`);
            if (!statusEl) return;
            
            const states = {
                'idle': '<i class="fas fa-circle text-gray-500 mr-1"></i>idle',
                'streaming': '<i class="fas fa-circle text-green-400 mr-1 animate-pulse"></i>live',
                'disconnected': '<i class="fas fa-circle text-red-400 mr-1"></i>offline'
            };
            
            statusEl.innerHTML = states[state] || states['idle'];
        }

        // ========================================
        // INIT
        // ========================================
        checkAuth();
    </script>
</body>
</html>
