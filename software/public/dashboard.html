<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAMTAP - Teacher Dashboard</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/assets/TamTap-3D.png">
    <link rel="apple-touch-icon" href="/assets/TamTap-3D.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // FEU Color Palette Configuration
        tailwind.config = {
            theme: {
                screens: {
                    'xs': '360px',
                    'sm': '480px',
                    'md': '768px',
                    'lg': '1024px',
                    'xl': '1280px',
                    '2xl': '1536px',
                    '3xl': '1920px'
                },
                extend: {
                    colors: {
                        'feu-green': '#0a8249',
                        'feu-green-dark': '#034c16',
                        'feu-green-light': '#0eb063',
                        'feu-gold': '#FFD700',
                        'feu-gold-dark': '#D4AF37'
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Preloader -->
    <link rel="stylesheet" href="/css/preloader.css">
    <script src="/js/preloader.js"></script>
    <style>
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Status Dots */
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .status-present { background-color: #22c55e; }
        .status-late { background-color: #eab308; }
        .status-absent { background-color: #1f2937; }
        .status-unknown { background-color: #9ca3af; }
        
        /* Clickable Row */
        .clickable-row { cursor: pointer; transition: background-color 0.2s; }
        .clickable-row:hover { background-color: #f3f4f6; }
        
        /* Modal Backdrop */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        /* Disabled Card */
        .card-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* Dropdown Menu Animation */
        .dropdown-enter {
            animation: dropdownFade 0.15s ease-out;
        }
        @keyframes dropdownFade {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Active Nav Link */
        .nav-active {
            position: relative;
        }
        .nav-active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            right: 0;
            height: 3px;
            background: #0a8249;
            border-radius: 2px;
        }
        
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s ease-in-out infinite;
        }
        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-text { border-radius: 4px; height: 1rem; }
        .skeleton-text-sm { border-radius: 3px; height: 0.75rem; }
        .skeleton-text-lg { border-radius: 4px; height: 1.5rem; }
        .skeleton-text-xl { border-radius: 6px; height: 2.5rem; }
        .skeleton-circle { border-radius: 50%; }
        .skeleton-card { border-radius: 0.5rem; }
    </style>
</head>
<body style="padding-right: 0%;" class="bg-gray-50 min-h-screen flex flex-col">

    <!-- ========================================
         TOP BAR (Green with Address)
    ======================================== -->
    <div class="bg-feu-green text-white text-xs sm:text-sm py-1.5 sm:py-2 px-3 sm:px-4 lg:px-6">
        <div class="w-full max-w-[1920px] mx-auto flex items-center justify-between">
            <!-- Left: Address -->
            <div class="flex items-center gap-1.5 sm:gap-2">
                <i class="fas fa-location-dot text-xs sm:text-sm"></i>
                <span class="hidden lg:inline">504 J. P. Rizal St, Marikina, 1800 Metro Manila</span>
                <span class="hidden sm:inline lg:hidden">FEU Roosevelt Marikina</span>
                <span class="sm:hidden text-xs">FEU Roosevelt</span>
            </div>
            <!-- Right: Connection Status -->
            <div class="flex items-center gap-3">
                <span id="connection-status" class="px-2 py-0.5 rounded-full text-xs bg-white/20 inline-flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                    <span class="hidden sm:inline">Live</span>
                </span>
            </div>
        </div>
    </div>

    <!-- ========================================
         HEADER (White with Logo and Nav)
         Backend: GET /api/auth/me (user info)
    ======================================== -->
    <header class="bg-white py-3 sm:py-4 lg:py-5 px-3 sm:px-4 lg:px-6 xl:px-8 shadow-sm border-b">
        <div class="w-full max-w-[1920px] mx-auto flex items-center justify-between">
            <!-- Left: Logo -->
            <div class="flex items-center gap-2 sm:gap-3 lg:gap-4">
                <img src="/assets/TamTap-3D.png" 
                     alt="TAMTAP Mascot" 
                     class="h-10 w-10 sm:h-12 sm:w-12 lg:h-14 lg:w-14 xl:h-16 xl:w-16 object-contain"
                     onerror="this.src='/assets/TamTap.png'; this.onerror=null;">
                <div>
                    <span class="text-lg sm:text-xl lg:text-2xl xl:text-3xl font-bold">
                        <span class="text-feu-green">TAM</span><span class="text-feu-gold">TAP</span>
                    </span>
                    <p class="text-[10px] sm:text-xs lg:text-sm text-gray-500 font-medium">Teacher Dashboard</p>
                </div>
            </div>

            <!-- Center: Dashboard Title (Desktop) -->
            <div class="hidden xl:flex items-center">
                <span class="nav-active text-feu-green font-semibold text-lg px-4 py-2">Dashboard</span>
            </div>

            <!-- Right: User Menu -->
            <div class="flex items-center gap-2 sm:gap-3">
                <!-- Notification Icon -->
                <button id="notification-btn" 
                        class="text-gray-400 hover:text-feu-green transition p-1.5 sm:p-2 rounded-lg hover:bg-gray-100" 
                        title="Notifications">
                    <i class="fas fa-bell text-base sm:text-lg"></i>
                </button>
                
                <!-- User Dropdown -->
                <div class="relative">
                    <button onclick="toggleSettingsMenu()" 
                            class="flex items-center gap-1.5 sm:gap-2 hover:bg-gray-100 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg transition border border-gray-200">
                        <div class="w-7 h-7 sm:w-8 sm:h-8 bg-feu-green rounded-full flex items-center justify-center text-white font-bold text-xs sm:text-sm">
                            <span id="user-initials">T</span>
                        </div>
                        <span id="user-name" class="hidden md:inline text-sm font-medium text-gray-700 max-w-[120px] truncate">Teacher</span>
                        <i class="fas fa-chevron-down text-[10px] sm:text-xs text-gray-400"></i>
                    </button>
                    
                    <!-- Settings Dropdown Menu -->
                    <div id="settings-menu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-xl z-50 border dropdown-enter overflow-hidden">
                        <div class="p-4 bg-gradient-to-r from-feu-green to-feu-green-dark text-white">
                            <p id="menu-user-name" class="font-bold">Teacher Name</p>
                            <p id="menu-user-role" class="text-sm text-white/80 capitalize">Role</p>
                        </div>
                        <ul class="py-2">
                            <!-- Admin Panel Link (Admin Only) -->
                            <li id="admin-link" class="hidden">
                                <a href="/admin.html" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-50 flex items-center gap-3 transition">
                                    <i class="fas fa-cog text-feu-gold w-5"></i> Admin Panel
                                </a>
                            </li>
                            <li>
                                <button onclick="showPersonalInfo()" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-50 flex items-center gap-3 transition">
                                    <i class="fas fa-user text-feu-green w-5"></i> Personal Information
                                </button>
                            </li>
                            <li>
                                <button onclick="showHelpCenter()" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-50 flex items-center gap-3 transition">
                                    <i class="fas fa-circle-question text-feu-green w-5"></i> Help Center
                                </button>
                            </li>
                            <li class="border-t mt-2 pt-2">
                                <button onclick="logout()" class="w-full text-left px-4 py-3 text-red-600 hover:bg-red-50 flex items-center gap-3 transition">
                                    <i class="fas fa-right-from-bracket w-5"></i> Log Out
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ========================================
         TOP FILTER BAR
         Backend: GET /api/auth/me (sections_handled)
    ======================================== -->
    <div class="bg-gray-50 border-b">
        <div class="w-full max-w-[1920px] mx-auto px-3 sm:px-4 lg:px-6 xl:px-8 py-2 sm:py-3 flex flex-wrap items-center gap-2 sm:gap-4">
            <!-- Section Selector -->
            <div class="flex items-center gap-1.5 sm:gap-2">
                <label for="section-select" class="text-xs sm:text-sm font-semibold text-gray-600 uppercase tracking-wide hidden sm:inline">
                    <i class="fas fa-users text-feu-green mr-1"></i> Section
                </label>
                <i class="fas fa-users text-feu-green sm:hidden"></i>
                <select id="section-select" 
                        onchange="onSectionChange()"
                        class="border-2 border-gray-200 rounded-lg px-2 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm font-medium bg-white focus:ring-2 focus:ring-feu-green focus:border-feu-green transition min-w-[100px] sm:min-w-[140px]">
                    <option value="">Loading...</option>
                </select>
            </div>
            
            <!-- Date Range Tabs -->
            <div class="flex items-center gap-0.5 sm:gap-1 ml-auto overflow-x-auto">
                <button onclick="setDateRange('today')" 
                        id="tab-today"
                        class="date-tab px-2 sm:px-3 lg:px-4 py-1.5 sm:py-2 text-xs sm:text-sm rounded-lg bg-feu-green text-white whitespace-nowrap">
                    Today
                </button>
                <button onclick="setDateRange('week')" 
                        id="tab-week"
                        class="date-tab px-2 sm:px-3 lg:px-4 py-1.5 sm:py-2 text-xs sm:text-sm rounded-lg text-gray-600 hover:bg-gray-100 whitespace-nowrap">
                    <span class="hidden sm:inline">This </span>Week
                </button>
                <button onclick="setDateRange('month')" 
                        id="tab-month"
                        class="date-tab px-2 sm:px-3 lg:px-4 py-1.5 sm:py-2 text-xs sm:text-sm rounded-lg text-gray-600 hover:bg-gray-100 whitespace-nowrap">
                    <span class="hidden sm:inline">This </span>Month
                </button>
                <button onclick="setDateRange('custom')" 
                        id="tab-custom"
                        class="date-tab px-2 sm:px-3 lg:px-4 py-1.5 sm:py-2 text-xs sm:text-sm rounded-lg text-gray-600 hover:bg-gray-100 whitespace-nowrap">
                    <i class="fas fa-calendar-alt mr-1"></i><span class="hidden sm:inline">Custom</span>
                </button>
            </div>
            
            <!-- Custom Date Picker (hidden by default) -->
            <div id="custom-date-picker" class="hidden items-center gap-2">
                <input type="date" id="custom-date" 
                       onchange="onCustomDateChange()"
                       class="border-2 border-gray-200 rounded-lg px-2 sm:px-3 py-1.5 text-xs sm:text-sm bg-white focus:ring-2 focus:ring-feu-green focus:border-feu-green">
            </div>
            
            <!-- Date Display -->
            <div class="text-xs sm:text-sm text-gray-500 font-medium hidden sm:flex items-center">
                <i class="fas fa-calendar-day text-feu-green mr-1"></i>
                <span id="date-display">--</span>
            </div>
        </div>
    </div>

    <main class="w-full max-w-[1920px] mx-auto px-3 sm:px-4 lg:px-6 xl:px-8 2xl:px-12 py-4 sm:py-6 lg:py-8 flex-1">
        <!-- ========================================
             WELCOME HEADER
             Backend: GET /api/auth/me (name)
        ======================================== -->
        <div class="mb-4 sm:mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4">
            <div>
                <p class="text-sm sm:text-base lg:text-lg text-gray-600 font-medium">Welcome back,</p>
                <h2 class="text-xl sm:text-2xl lg:text-3xl xl:text-4xl font-bold mt-0.5">
                    <span id="welcome-name" class="text-feu-green">Teacher</span>!
                </h2>
                <p class="text-gray-500 text-xs sm:text-sm mt-1 sm:mt-2">
                    <span id="current-section-display">All Sections</span> • 
                    <span id="current-date-display">Today</span>
                </p>
            </div>
            <!-- Refresh Button -->
            <button onclick="refreshData()" 
                    class="bg-feu-green hover:bg-feu-gold hover:text-feu-green-dark text-white px-3 sm:px-4 lg:px-5 py-2 sm:py-2.5 rounded-lg flex items-center justify-center gap-2 transition font-medium shadow-sm text-sm sm:text-base w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-feu-green focus:ring-offset-2">
                <i class="fas fa-sync-alt" id="refresh-icon"></i>
                <span>Refresh</span>
            </button>
        </div>

        <!-- ========================================
             ATTENDANCE SUMMARY CARD
             Backend: GET /api/stats
             Shows total students and attendance rate
             If breakdown data missing: shows notice
        ======================================== -->
        <div class="bg-gradient-to-r from-feu-green to-feu-green-dark rounded-lg sm:rounded-xl shadow-lg p-4 sm:p-5 lg:p-6 xl:p-8 mb-4 sm:mb-6 text-white">
            <div class="flex items-center justify-between mb-3 sm:mb-4">
                <h3 class="text-base sm:text-lg lg:text-xl xl:text-2xl font-bold">
                    <i class="fas fa-chart-pie mr-1.5 sm:mr-2"></i> Attendance Summary
                </h3>
                <span id="summary-date-range" class="text-feu-gold text-xs sm:text-sm">Today</span>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 lg:gap-6">
                <!-- Total Students -->
                <div class="bg-white/10 rounded-lg p-3 sm:p-4">
                    <p class="text-white/80 text-xs sm:text-sm mb-0.5 sm:mb-1">Total Students</p>
                    <p id="total-students" class="text-2xl sm:text-3xl lg:text-4xl xl:text-5xl font-bold">--</p>
                </div>
                
                <!-- Attendance Percentage -->
                <div class="bg-white/10 rounded-lg p-3 sm:p-4">
                    <p class="text-white/80 text-xs sm:text-sm mb-0.5 sm:mb-1">Attendance Rate</p>
                    <p id="attendance-rate" class="text-2xl sm:text-3xl lg:text-4xl xl:text-5xl font-bold">--%</p>
                    <!-- Progress Bar -->
                    <div class="mt-2 sm:mt-3 bg-white/20 rounded-full h-2 sm:h-3">
                        <div id="attendance-bar" 
                             class="bg-feu-gold h-2 sm:h-3 rounded-full transition-all duration-500" 
                             style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Breakdown Notice (shown if detailed data unavailable) -->
            <div id="breakdown-notice" class="hidden mt-4 bg-white/10 rounded-lg p-3 text-center">
                <i class="fas fa-info-circle mr-2"></i>
                <span class="text-sm">Detailed breakdown unavailable</span>
            </div>
        </div>

        <!-- ========================================
             SUMMARY CARDS (On-time / Late / Absent)
             Backend: GET /api/stats (status breakdown)
             NOTE: These may be disabled if backend 
                   doesn't return breakdown data
        ======================================== -->
        
        <!-- Skeleton: Summary Cards -->
        <div id="summary-cards-skeleton" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div class="bg-white rounded-lg sm:rounded-xl shadow p-3 sm:p-4 lg:p-5 border-l-4 border-gray-200 min-h-[100px] sm:min-h-[120px]">
                <div class="flex items-center justify-between h-full">
                    <div class="flex-1">
                        <div class="skeleton skeleton-text-sm w-24 mb-2"></div>
                        <div class="skeleton skeleton-text-xl w-16"></div>
                    </div>
                    <div class="skeleton skeleton-circle w-10 h-10 sm:w-12 sm:h-12"></div>
                </div>
            </div>
            <div class="bg-white rounded-lg sm:rounded-xl shadow p-3 sm:p-4 lg:p-5 border-l-4 border-gray-200 min-h-[100px] sm:min-h-[120px]">
                <div class="flex items-center justify-between h-full">
                    <div class="flex-1">
                        <div class="skeleton skeleton-text-sm w-20 mb-2"></div>
                        <div class="skeleton skeleton-text-xl w-12"></div>
                    </div>
                    <div class="skeleton skeleton-circle w-10 h-10 sm:w-12 sm:h-12"></div>
                </div>
            </div>
            <div class="bg-white rounded-lg sm:rounded-xl shadow p-3 sm:p-4 lg:p-5 border-l-4 border-gray-200 min-h-[100px] sm:min-h-[120px] sm:col-span-2 lg:col-span-1">
                <div class="flex items-center justify-between h-full">
                    <div class="flex-1">
                        <div class="skeleton skeleton-text-sm w-20 mb-2"></div>
                        <div class="skeleton skeleton-text-xl w-12"></div>
                    </div>
                    <div class="skeleton skeleton-circle w-10 h-10 sm:w-12 sm:h-12"></div>
                </div>
            </div>
        </div>
        
        <div id="summary-cards" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-4 sm:mb-6">
            <!-- Arrived On Time -->
            <div id="card-ontime" class="bg-white rounded-lg sm:rounded-xl shadow p-3 sm:p-4 lg:p-5 border-l-4 border-green-500 min-h-[100px] sm:min-h-[120px]">
                <div class="flex items-center justify-between h-full">
                    <div>
                        <p class="text-gray-500 text-xs sm:text-sm">Arrived On Time</p>
                        <p id="count-ontime" class="text-2xl sm:text-3xl lg:text-4xl font-bold text-green-600">--</p>
                    </div>
                    <div class="bg-green-100 p-2 sm:p-3 rounded-full">
                        <i class="fas fa-check-circle text-xl sm:text-2xl text-green-600"></i>
                    </div>
                </div>
            </div>
            
            <!-- Arrived Late -->
            <div id="card-late" class="bg-white rounded-lg sm:rounded-xl shadow p-3 sm:p-4 lg:p-5 border-l-4 border-yellow-500 min-h-[100px] sm:min-h-[120px]">
                <div class="flex items-center justify-between h-full">
                    <div>
                        <p class="text-gray-500 text-xs sm:text-sm">Arrived Late</p>
                        <p id="count-late" class="text-2xl sm:text-3xl lg:text-4xl font-bold text-yellow-600">--</p>
                    </div>
                    <div class="bg-yellow-100 p-2 sm:p-3 rounded-full">
                        <i class="fas fa-clock text-xl sm:text-2xl text-yellow-600"></i>
                    </div>
                </div>
            </div>
            
            <!-- Didn't Arrive -->
            <div id="card-absent" class="bg-white rounded-lg sm:rounded-xl shadow p-3 sm:p-4 lg:p-5 border-l-4 border-gray-700 min-h-[100px] sm:min-h-[120px] sm:col-span-2 lg:col-span-1">
                <div class="flex items-center justify-between h-full">
                    <div>
                        <p class="text-gray-500 text-xs sm:text-sm">Didn't Arrive</p>
                        <p id="count-absent" class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-700">--</p>
                    </div>
                    <div class="bg-gray-200 p-2 sm:p-3 rounded-full">
                        <i class="fas fa-user-xmark text-xl sm:text-2xl text-gray-700"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Summary Cards Unavailable Notice -->
        <div id="summary-unavailable" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6 text-center">
            <i class="fas fa-exclamation-triangle text-yellow-600 mr-1 sm:mr-2"></i>
            <span class="text-yellow-700 text-xs sm:text-sm">
                Status breakdown pending backend support. Showing attendance records only.
            </span>
        </div>

        <!-- ========================================
             STUDENT ATTENDANCE TABLE
             Backend: GET /api/attendance?section=&date=
             Rows clickable → shows history modal
        ======================================== -->
        <div class="bg-white rounded-lg sm:rounded-xl shadow overflow-hidden">
            <!-- Table Header -->
            <div class="p-3 sm:p-4 border-b flex flex-col sm:flex-row sm:items-center justify-between gap-2 sm:gap-4">
                <h3 class="text-base sm:text-lg font-semibold text-gray-800">
                    <i class="fas fa-table text-feu-green mr-1.5 sm:mr-2"></i> Student Attendance
                </h3>
                <div class="flex items-center gap-2 sm:gap-4">
                    <!-- Record Count -->
                    <span id="record-count" class="text-xs sm:text-sm text-gray-500">0 records</span>
                    <!-- Export Dropdown -->
                    <div class="relative">
                        <button onclick="toggleExportMenu()" 
                                class="bg-feu-green hover:bg-feu-green-dark text-white px-2.5 sm:px-3 py-1.5 sm:py-2 rounded-lg text-xs sm:text-sm flex items-center gap-1.5 focus:outline-none focus:ring-2 focus:ring-feu-green min-h-[36px]">
                            <i class="fas fa-download"></i> 
                            <span class="hidden xs:inline">Export</span>
                            <i class="fas fa-chevron-down text-[10px] ml-1"></i>
                        </button>
                        <!-- Export Menu -->
                        <div id="export-menu" class="hidden absolute right-0 mt-1 w-40 bg-white rounded-lg shadow-xl z-50 border dropdown-enter overflow-hidden">
                            <button onclick="exportXLSX()" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <i class="fas fa-file-excel text-green-600 w-5"></i> Excel (.xlsx)
                            </button>
                            <button onclick="exportPDF()" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <i class="fas fa-file-pdf text-red-600 w-5"></i> PDF Report
                            </button>
                            <div class="border-t"></div>
                            <button onclick="exportCSV()" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <i class="fas fa-file-csv text-blue-600 w-5"></i> CSV (Basic)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Legend -->
            <div class="px-3 sm:px-4 py-1.5 sm:py-2 bg-gray-50 border-b flex flex-wrap gap-2 sm:gap-4 text-[10px] sm:text-xs text-gray-600">
                <span><span class="status-dot status-present mr-0.5 sm:mr-1"></span> Present</span>
                <span><span class="status-dot status-late mr-0.5 sm:mr-1"></span> Late</span>
                <span><span class="status-dot status-absent mr-0.5 sm:mr-1"></span> Absent</span>
                <span class="hidden sm:inline"><span class="status-dot status-unknown mr-1"></span> Unknown</span>
            </div>
            
            <!-- Table (Desktop/Tablet) -->
            <div class="overflow-x-auto hidden sm:block">
                <table class="w-full">
                    <caption class="sr-only">Student attendance records</caption>
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-3 lg:px-4 py-2 lg:py-3 text-center text-[10px] lg:text-xs font-medium text-gray-500 uppercase w-16 lg:w-20">Photo</th>
                            <th class="px-3 lg:px-4 py-2 lg:py-3 text-left text-[10px] lg:text-xs font-medium text-gray-500 uppercase">Student Name</th>
                            <th class="px-3 lg:px-4 py-2 lg:py-3 text-center text-[10px] lg:text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-3 lg:px-4 py-2 lg:py-3 text-left text-[10px] lg:text-xs font-medium text-gray-500 uppercase">Time</th>
                            <th class="px-3 lg:px-4 py-2 lg:py-3 text-left text-[10px] lg:text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Session</th>
                            <th class="px-3 lg:px-4 py-2 lg:py-3 text-left text-[10px] lg:text-xs font-medium text-gray-500 uppercase hidden lg:table-cell">Section</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-table-skeleton" class="divide-y divide-gray-200">
                        <tr>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 text-center"><div class="skeleton skeleton-circle w-10 h-10 lg:w-12 lg:h-12 mx-auto"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3"><div class="skeleton skeleton-text w-32"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 text-center"><div class="skeleton skeleton-circle w-3 h-3 mx-auto"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3"><div class="skeleton skeleton-text w-16"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 hidden md:table-cell"><div class="skeleton skeleton-text-sm w-10"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 hidden lg:table-cell"><div class="skeleton skeleton-text-sm w-14"></div></td>
                        </tr>
                        <tr>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 text-center"><div class="skeleton skeleton-circle w-10 h-10 lg:w-12 lg:h-12 mx-auto"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3"><div class="skeleton skeleton-text w-28"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 text-center"><div class="skeleton skeleton-circle w-3 h-3 mx-auto"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3"><div class="skeleton skeleton-text w-16"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 hidden md:table-cell"><div class="skeleton skeleton-text-sm w-10"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 hidden lg:table-cell"><div class="skeleton skeleton-text-sm w-14"></div></td>
                        </tr>
                        <tr>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 text-center"><div class="skeleton skeleton-circle w-10 h-10 lg:w-12 lg:h-12 mx-auto"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3"><div class="skeleton skeleton-text w-36"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 text-center"><div class="skeleton skeleton-circle w-3 h-3 mx-auto"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3"><div class="skeleton skeleton-text w-16"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 hidden md:table-cell"><div class="skeleton skeleton-text-sm w-10"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 hidden lg:table-cell"><div class="skeleton skeleton-text-sm w-14"></div></td>
                        </tr>
                        <tr>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 text-center"><div class="skeleton skeleton-circle w-10 h-10 lg:w-12 lg:h-12 mx-auto"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3"><div class="skeleton skeleton-text w-24"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 text-center"><div class="skeleton skeleton-circle w-3 h-3 mx-auto"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3"><div class="skeleton skeleton-text w-16"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 hidden md:table-cell"><div class="skeleton skeleton-text-sm w-10"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 hidden lg:table-cell"><div class="skeleton skeleton-text-sm w-14"></div></td>
                        </tr>
                        <tr>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 text-center"><div class="skeleton skeleton-circle w-10 h-10 lg:w-12 lg:h-12 mx-auto"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3"><div class="skeleton skeleton-text w-30"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 text-center"><div class="skeleton skeleton-circle w-3 h-3 mx-auto"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3"><div class="skeleton skeleton-text w-16"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 hidden md:table-cell"><div class="skeleton skeleton-text-sm w-10"></div></td>
                            <td class="px-3 lg:px-4 py-2 lg:py-3 hidden lg:table-cell"><div class="skeleton skeleton-text-sm w-14"></div></td>
                        </tr>
                    </tbody>
                    <tbody id="attendance-table" class="hidden divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            
            <!-- Mobile Card View -->
            <div id="attendance-cards-skeleton" class="sm:hidden divide-y divide-gray-100">
                <div class="p-3"><div class="flex items-center gap-3"><div class="skeleton skeleton-circle w-12 h-12 flex-shrink-0"></div><div class="flex-1"><div class="skeleton skeleton-text w-32 mb-2"></div><div class="skeleton skeleton-text-sm w-20"></div></div><div class="skeleton skeleton-text-sm w-12"></div></div></div>
                <div class="p-3"><div class="flex items-center gap-3"><div class="skeleton skeleton-circle w-12 h-12 flex-shrink-0"></div><div class="flex-1"><div class="skeleton skeleton-text w-28 mb-2"></div><div class="skeleton skeleton-text-sm w-24"></div></div><div class="skeleton skeleton-text-sm w-12"></div></div></div>
                <div class="p-3"><div class="flex items-center gap-3"><div class="skeleton skeleton-circle w-12 h-12 flex-shrink-0"></div><div class="flex-1"><div class="skeleton skeleton-text w-36 mb-2"></div><div class="skeleton skeleton-text-sm w-16"></div></div><div class="skeleton skeleton-text-sm w-12"></div></div></div>
            </div>
            <div id="attendance-cards" class="hidden sm:hidden divide-y divide-gray-100">
                <!-- Cards rendered by JS -->
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="hidden p-6 sm:p-8 text-center text-gray-400">
                <i class="fas fa-inbox text-3xl sm:text-4xl mb-2 sm:mb-3"></i>
                <p class="text-sm sm:text-base">No attendance records found</p>
                <p class="text-xs sm:text-sm">Select a section and date to view records</p>
            </div>
        </div>
    </main>

    <!-- ========================================
         STUDENT DETAIL MODAL
         Backend: GET /api/attendance/student/:nfc_id
         Shows summary cards + attendance history table
    ======================================== -->
    <div id="student-detail-modal" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop" role="dialog" aria-modal="true">
        <div class="bg-white rounded-lg sm:rounded-xl shadow-2xl w-[96%] sm:w-full max-w-[400px] sm:max-w-lg lg:max-w-2xl mx-auto max-h-[90vh] flex flex-col fade-in">
            <!-- Modal Header -->
            <div class="p-3 sm:p-4 border-b flex items-center justify-between bg-gradient-to-r from-feu-green to-feu-green-dark text-white rounded-t-lg sm:rounded-t-xl">
                <div>
                    <h3 class="text-sm sm:text-base lg:text-lg font-semibold">
                        <i class="fas fa-user-graduate mr-1.5 sm:mr-2"></i>
                        <span id="detail-student-name">Student Name</span>
                    </h3>
                    <p id="detail-student-section" class="text-xs sm:text-sm text-white/80">Section</p>
                </div>
                <button onclick="closeStudentDetailModal()" class="text-white/80 hover:text-white text-lg sm:text-xl p-1" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Summary Cards -->
            <div id="detail-summary" class="p-3 sm:p-4 bg-gray-50 border-b">
                <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 sm:gap-3">
                    <div class="bg-white rounded-lg p-2 sm:p-3 text-center shadow-sm border">
                        <p class="text-lg sm:text-2xl font-bold text-gray-800" id="detail-total">--</p>
                        <p class="text-[10px] sm:text-xs text-gray-500">Total Days</p>
                    </div>
                    <div class="bg-white rounded-lg p-2 sm:p-3 text-center shadow-sm border border-green-200">
                        <p class="text-lg sm:text-2xl font-bold text-green-600" id="detail-present">--</p>
                        <p class="text-[10px] sm:text-xs text-gray-500">Present</p>
                    </div>
                    <div class="bg-white rounded-lg p-2 sm:p-3 text-center shadow-sm border border-yellow-200">
                        <p class="text-lg sm:text-2xl font-bold text-yellow-600" id="detail-late">--</p>
                        <p class="text-[10px] sm:text-xs text-gray-500">Late</p>
                    </div>
                    <div class="bg-white rounded-lg p-2 sm:p-3 text-center shadow-sm border border-gray-300">
                        <p class="text-lg sm:text-2xl font-bold text-gray-700" id="detail-absent">--</p>
                        <p class="text-[10px] sm:text-xs text-gray-500">Absent</p>
                    </div>
                    <div class="bg-white rounded-lg p-2 sm:p-3 text-center shadow-sm border border-blue-200">
                        <p class="text-lg sm:text-2xl font-bold text-blue-600" id="detail-excused">--</p>
                        <p class="text-[10px] sm:text-xs text-gray-500">Excused</p>
                    </div>
                    <div class="bg-white rounded-lg p-2 sm:p-3 text-center shadow-sm border border-feu-green">
                        <p class="text-lg sm:text-2xl font-bold text-feu-green" id="detail-rate">--%</p>
                        <p class="text-[10px] sm:text-xs text-gray-500">Rate</p>
                    </div>
                </div>
            </div>
            
            <!-- History Table -->
            <div id="detail-history" class="p-3 sm:p-4 overflow-y-auto flex-1">
                <h4 class="text-xs sm:text-sm font-semibold text-gray-600 uppercase mb-2 flex items-center">
                    <i class="fas fa-history text-feu-green mr-1.5"></i> Attendance History
                </h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs sm:text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-2 sm:px-3 py-2 text-left font-medium text-gray-500">Date</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-medium text-gray-500">Time</th>
                                <th class="px-2 sm:px-3 py-2 text-center font-medium text-gray-500">Status</th>
                                <th class="px-2 sm:px-3 py-2 text-center font-medium text-gray-500">Photo</th>
                            </tr>
                        </thead>
                        <tbody id="detail-records" class="divide-y divide-gray-100">
                            <tr><td colspan="4" class="px-3 py-4 text-center text-gray-400">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="p-3 sm:p-4 border-t text-center">
                <button onclick="closeStudentDetailModal()" 
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 sm:px-6 py-1.5 sm:py-2 rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-gray-400">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- ========================================
         PHOTO VIEW MODAL
         Displays attendance photo in larger view
    ======================================== -->
    <div id="photo-modal" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop" role="dialog" aria-modal="true">
        <div class="bg-white rounded-lg sm:rounded-xl shadow-2xl w-[94%] sm:w-full max-w-[400px] sm:max-w-md lg:max-w-lg mx-auto fade-in">
            <!-- Modal Header -->
            <div class="p-3 sm:p-4 border-b flex items-center justify-between">
                <h3 class="text-sm sm:text-base lg:text-lg font-semibold text-gray-800">
                    <i class="fas fa-camera text-feu-green mr-1.5 sm:mr-2"></i>
                    <span id="photo-student-name">Student Photo</span>
                </h3>
                <button onclick="closePhotoModal()" class="text-gray-400 hover:text-gray-600 text-lg sm:text-xl p-1" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-3 sm:p-4">
                <div class="relative bg-gray-100 rounded-lg overflow-hidden">
                    <img id="photo-modal-image" 
                         src="" 
                         alt="Attendance Photo" 
                         class="w-full h-auto max-h-[400px] object-contain">
                    <div id="photo-loading" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-100">
                        <img src="/assets/animations/tamtap-walking.gif" alt="Loading..." class="w-16 h-16 sm:w-20 sm:h-20">
                        <p class="text-sm text-feu-green mt-2">Loading photo...</p>
                    </div>
                </div>
                <div id="photo-details" class="mt-3 text-center text-sm text-gray-600">
                    <!-- Photo details rendered by JS -->
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="p-3 sm:p-4 border-t text-center">
                <button onclick="closePhotoModal()" 
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 sm:px-6 py-1.5 sm:py-2 rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-gray-400">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- ========================================
         PERSONAL INFO MODAL
         Backend: GET /api/auth/me
    ======================================== -->
    <div id="personal-modal" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop" role="dialog" aria-modal="true">
        <div class="bg-white rounded-lg sm:rounded-xl shadow-2xl w-[94%] sm:w-full max-w-[340px] sm:max-w-md mx-auto fade-in max-h-[85vh] overflow-y-auto">
            <div class="p-3 sm:p-4 border-b flex items-center justify-between">
                <h3 class="text-sm sm:text-base lg:text-lg font-semibold text-gray-800">
                    <i class="fas fa-user text-feu-green mr-1.5 sm:mr-2"></i> Personal Information
                </h3>
                <button onclick="closePersonalModal()" class="text-gray-400 hover:text-gray-600 text-lg sm:text-xl p-1" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="personal-content" class="p-4 sm:p-6">
                <p class="text-gray-400 text-center text-sm">Loading...</p>
            </div>
            <div class="p-3 sm:p-4 border-t text-center">
                <button onclick="closePersonalModal()" 
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 sm:px-6 py-1.5 sm:py-2 rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-gray-400">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- ========================================
         FOOTER
    ======================================== -->
    <footer class="bg-feu-green py-3 sm:py-4 lg:py-5 mt-auto border-t-4 border-feu-gold">
        <div class="w-full max-w-[1920px] mx-auto px-3 sm:px-4 lg:px-6 xl:px-8 flex flex-col sm:flex-row items-center justify-between gap-3 sm:gap-4">
            <!-- Left: FEU Logo + TAMTAP Mascot -->
            <div class="flex items-center gap-2 sm:gap-3 lg:gap-4">
                <img src="/assets/logos/feu-logo.png" 
                     alt="FEU" 
                     class="h-8 w-8 sm:h-10 sm:w-10 lg:h-12 lg:w-12 object-contain"
                     onerror="this.style.display='none'">
                <div class="flex items-center gap-1.5 sm:gap-2">
                    <img src="/assets/TamTap-3D.png" 
                         alt="TAMTAP Mascot" 
                         class="h-7 w-7 sm:h-8 sm:w-8 lg:h-10 lg:w-10 object-contain"
                         onerror="this.style.display='none'">
                    <span class="text-base sm:text-lg lg:text-xl font-bold">
                        <span class="text-white">TAM</span><span class="text-feu-gold">TAP</span>
                    </span>
                </div>
            </div>
            
            <!-- Right: Capstone Info -->
            <div class="text-center sm:text-right">
                <p class="text-white/90 text-xs sm:text-sm font-medium italic">Grade 12 ICT Capstone S.Y. 2025-2026</p>
                <p class="text-white/60 text-[10px] sm:text-xs mt-0.5">FEU Roosevelt Marikina</p>
            </div>
        </div>
    </footer>

    <script>
        // ========================================
        // GLOBALS
        // ========================================
        let currentUser = null;
        let socket = null;
        let currentRecords = [];
        let currentDateRange = 'today';
        let breakdownAvailable = false; // Track if backend provides status breakdown

        // ========================================
        // AUTH CHECK (GET /api/auth/me)
        // Redirect to login if not authenticated
        // ========================================
        async function checkAuth() {
            try {
                const res = await fetch('/api/auth/me', { credentials: 'include' });
                if (!res.ok) {
                    window.location.href = '/login.html';
                    return;
                }
                const data = await res.json();
                if (!data.success || !data.user) {
                    window.location.href = '/login.html';
                    return;
                }
                
                currentUser = data.user;
                
                // Update UI with user info
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('welcome-name').textContent = currentUser.name;
                document.getElementById('menu-user-name').textContent = currentUser.name;
                document.getElementById('menu-user-role').textContent = 
                    currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
                
                // Set user initials
                const nameParts = currentUser.name.split(' ');
                const initials = nameParts.length >= 2 
                    ? nameParts[0][0] + nameParts[nameParts.length - 1][0]
                    : currentUser.name.substring(0, 2);
                document.getElementById('user-initials').textContent = initials.toUpperCase();
                
                // Show Admin Panel link if user is admin
                if (currentUser.role === 'admin') {
                    document.getElementById('admin-link').classList.remove('hidden');
                }
                
                // Initialize dashboard
                initDashboard();
                
            } catch (e) {
                console.error('[ERROR] Auth check failed:', e);
                window.location.href = '/login.html';
            }
        }

        // ========================================
        // LOGOUT (POST /api/auth/logout)
        // ========================================
        async function logout() {
            showPreloader('Logging out...');
            try {
                await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
            } catch (e) {
                console.error('[ERROR] Logout error:', e);
            }
            navigateTo('/login.html', 'Redirecting to login...');
        }

        // ========================================
        // DASHBOARD INITIALIZATION
        // ========================================
        async function initDashboard() {
            // Populate section dropdown from user's sections_handled
            populateSectionDropdown();
            
            // Set default date display
            updateDateDisplay();
            
            // Connect Socket.IO
            initSocket();
            
            // Load initial data
            refreshData();
        }

        // ========================================
        // SECTION DROPDOWN
        // Backend: Uses sections_handled from GET /api/auth/me
        // ========================================
        function populateSectionDropdown() {
            const select = document.getElementById('section-select');
            if (!select) {
                console.error('[ERROR] Section select element not found');
                return;
            }
            
            const sections = currentUser?.sections_handled || [];
            console.log('[DEBUG] Sections handled:', sections);
            
            if (sections.length === 0) {
                // No sections assigned - show empty state
                select.innerHTML = '<option value="">No sections assigned</option>';
                const display = document.getElementById('current-section-display');
                if (display) display.textContent = 'No sections';
                return;
            }
            
            // Build options
            let html = '<option value="">All My Sections</option>';
            sections.forEach(s => {
                html += `<option value="${s}">${s}</option>`;
            });
            select.innerHTML = html;
            
            const display = document.getElementById('current-section-display');
            if (display) display.textContent = 'All Sections';
        }

        function onSectionChange() {
            const section = document.getElementById('section-select').value;
            document.getElementById('current-section-display').textContent = section || 'All Sections';
            refreshData();
        }

        // ========================================
        // DATE RANGE TABS
        // ========================================
        let customDate = null; // For custom date picker
        
        function setDateRange(range) {
            currentDateRange = range;
            
            // Update tab styles
            document.querySelectorAll('.date-tab').forEach(tab => {
                tab.classList.remove('bg-feu-green', 'text-white');
                tab.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            const activeTab = document.getElementById(`tab-${range}`);
            if (activeTab) {
                activeTab.classList.remove('text-gray-600', 'hover:bg-gray-100');
                activeTab.classList.add('bg-feu-green', 'text-white');
            }
            
            // Show/hide custom date picker
            const datePicker = document.getElementById('custom-date-picker');
            if (range === 'custom') {
                datePicker.classList.remove('hidden');
                datePicker.classList.add('flex');
                // Set default to today if not set
                if (!document.getElementById('custom-date').value) {
                    document.getElementById('custom-date').value = new Date().toISOString().split('T')[0];
                }
                // Set max date to today (no future dates)
                document.getElementById('custom-date').max = new Date().toISOString().split('T')[0];
            } else {
                datePicker.classList.add('hidden');
                datePicker.classList.remove('flex');
                customDate = null;
            }
            
            updateDateDisplay();
            refreshData();
        }
        
        function onCustomDateChange() {
            const dateInput = document.getElementById('custom-date');
            const selectedDate = new Date(dateInput.value);
            const day = selectedDate.getDay();
            
            // Check if Sunday (disabled)
            if (day === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Sunday Selected',
                    text: 'Sundays are non-instructional days. No classes.',
                    confirmButtonColor: '#0a8249'
                });
                return;
            }
            
            // Check if Saturday (need to verify if enabled)
            if (day === 6) {
                // Check Saturday setting from backend
                checkSaturdayEnabled(dateInput.value);
                return;
            }
            
            customDate = dateInput.value;
            updateDateDisplay();
            refreshData();
        }
        
        async function checkSaturdayEnabled(dateValue) {
            try {
                const res = await fetch('/api/calendar/saturday-status', { credentials: 'include' });
                const data = await res.json();
                
                if (!data.saturdayClassesEnabled) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Saturday Classes Disabled',
                        text: 'Saturday classes are currently disabled by admin.',
                        confirmButtonColor: '#0a8249'
                    });
                    return;
                }
                
                customDate = dateValue;
                updateDateDisplay();
                refreshData();
            } catch (e) {
                console.error('[ERROR] Failed to check Saturday status:', e);
                customDate = dateValue;
                updateDateDisplay();
                refreshData();
            }
        }

        function updateDateDisplay() {
            const today = new Date();
            let display = '';
            let summaryDisplay = '';
            
            switch (currentDateRange) {
                case 'today':
                    display = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    summaryDisplay = 'Today';
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    display = `Week of ${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                    summaryDisplay = 'This Week';
                    break;
                case 'month':
                    display = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    summaryDisplay = 'This Month';
                    break;
                case 'custom':
                    if (customDate) {
                        const d = new Date(customDate);
                        display = d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                        summaryDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    } else {
                        display = 'Select a date';
                        summaryDisplay = 'Custom Date';
                    }
                    break;
                case 'semester':
                    display = 'Current Semester';
                    summaryDisplay = 'This Semester';
                    break;
            }
            
            document.getElementById('date-display').textContent = display;
            document.getElementById('current-date-display').textContent = summaryDisplay;
            document.getElementById('summary-date-range').textContent = summaryDisplay;
        }

        // ========================================
        // SOCKET.IO INITIALIZATION
        // Contract events: attendance:new, system:status
        // ========================================
        function initSocket() {
            try {
                socket = io();
                
                socket.on('connect', () => {
                    updateConnectionStatus(true);
                    console.log('[INFO] Socket.IO connected');
                });
                
                socket.on('disconnect', () => {
                    updateConnectionStatus(false);
                    console.log('[WARN] Socket.IO disconnected');
                });
                
                // Real-time attendance update
                socket.on('attendance:new', (data) => {
                    console.log('[INFO] New attendance:', data);
                    
                    // Check if matches current section filter
                    const currentSection = document.getElementById('section-select').value;
                    const userSections = currentUser.sections_handled || [];
                    
                    if (!currentSection) {
                        // "All My Sections" - check if in user's sections
                        if (userSections.length === 0 || userSections.includes(data.section)) {
                            addRecordToTable(data, true);
                            updateStats();
                        }
                    } else if (data.section === currentSection) {
                        addRecordToTable(data, true);
                        updateStats();
                    }
                    
                    // Show toast notification
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: `${data.name} checked in!`,
                        showConfirmButton: false,
                        timer: 3000
                    });
                });
                
                socket.on('system:status', (data) => {
                    console.log('[INFO] System status:', data);
                });
                
            } catch (e) {
                console.error('[ERROR] Socket.IO init failed:', e);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const badge = document.getElementById('connection-status');
            if (connected) {
                badge.className = 'px-2 py-0.5 rounded-full text-xs bg-white/20 inline-flex items-center gap-1';
                badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span><span class="hidden sm:inline">Live</span>';
            } else {
                badge.className = 'px-2 py-0.5 rounded-full text-xs bg-red-500/80 inline-flex items-center gap-1';
                badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-white"></span><span class="hidden sm:inline">Offline</span>';
            }
        }

        // ========================================
        // SKELETON LOADING HELPERS
        // ========================================
        function showSkeletons() {
            // Show skeletons
            document.getElementById('summary-cards-skeleton').classList.remove('hidden');
            document.getElementById('attendance-table-skeleton').classList.remove('hidden');
            document.getElementById('attendance-cards-skeleton').classList.remove('hidden');
            // Hide content
            document.getElementById('summary-cards').classList.add('hidden');
            document.getElementById('attendance-table').classList.add('hidden');
            document.getElementById('attendance-cards').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');
        }
        
        function hideSkeletons() {
            // Hide skeletons
            document.getElementById('summary-cards-skeleton').classList.add('hidden');
            document.getElementById('attendance-table-skeleton').classList.add('hidden');
            document.getElementById('attendance-cards-skeleton').classList.add('hidden');
            // Show summary cards (always show these)
            document.getElementById('summary-cards').classList.remove('hidden');
            document.getElementById('summary-cards').classList.add('grid');
            // Show attendance content only if we have records (empty-state handles the empty case)
            if (currentRecords && currentRecords.length > 0) {
                document.getElementById('attendance-table').classList.remove('hidden');
                document.getElementById('attendance-cards').classList.remove('hidden');
                document.getElementById('empty-state').classList.add('hidden');
            } else {
                // No records - show empty state (showEmptyState may have already done this)
                document.getElementById('empty-state').classList.remove('hidden');
            }
        }

        // ========================================
        // DATA LOADING
        // ========================================
        async function refreshData() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('fa-spin');
            
            // Show skeleton loading
            showSkeletons();
            
            // Create timeout promise (10 second max)
            const timeout = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Request timeout')), 10000)
            );
            
            try {
                // Race between data loading and timeout
                await Promise.race([
                    Promise.all([
                        loadAttendance(),
                        loadStats()
                    ]),
                    timeout
                ]);
            } catch (err) {
                console.error('[ERROR] Data loading failed or timed out:', err.message);
                // Show empty state on timeout/error
                showEmptyState();
            } finally {
                icon.classList.remove('fa-spin');
                // Hide skeletons after load
                hideSkeletons();
            }
        }

        // ========================================
        // GET DATE RANGE FOR API
        // Returns {from, to} based on currentDateRange
        // ========================================
        function getDateRange() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            switch (currentDateRange) {
                case 'today':
                    return { from: todayStr, to: todayStr };
                case 'week': {
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    return { 
                        from: weekStart.toISOString().split('T')[0], 
                        to: todayStr 
                    };
                }
                case 'month': {
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    return { 
                        from: monthStart.toISOString().split('T')[0], 
                        to: todayStr 
                    };
                }
                case 'custom': {
                    // Single day from custom date picker
                    if (customDate) {
                        return { from: customDate, to: customDate };
                    }
                    return { from: todayStr, to: todayStr };
                }
                default:
                    return { from: todayStr, to: todayStr };
            }
        }

        // ========================================
        // LOAD ATTENDANCE
        // Backend: GET /api/attendance/:date (single day)
        //          GET /api/attendance/range/query?from=&to= (range)
        // ========================================
        async function loadAttendance() {
            try {
                const section = document.getElementById('section-select').value;
                const { from, to } = getDateRange();
                
                let url;
                let queryParams = [];
                
                // Choose endpoint based on date range
                if (from === to) {
                    // Single day - use /:date endpoint
                    url = `/api/attendance/${from}`;
                } else {
                    // Date range - use /range/query endpoint
                    url = '/api/attendance/range/query';
                    queryParams.push(`from=${from}`, `to=${to}`);
                }
                
                // Add section filter
                if (section) {
                    queryParams.push(`section=${encodeURIComponent(section)}`);
                } else {
                    // All sections for this teacher
                    const sections = currentUser.sections_handled || [];
                    if (sections.length > 0) {
                        queryParams.push(`sections=${encodeURIComponent(sections.join(','))}`);
                    }
                }
                
                if (queryParams.length > 0) {
                    url += (url.includes('?') ? '&' : '?') + queryParams.join('&');
                }
                
                console.log('[DEBUG] Fetching attendance:', url);
                
                const res = await fetch(url, { credentials: 'include' });
                
                if (!res.ok) {
                    console.error('[ERROR] Attendance fetch failed:', res.status);
                    showEmptyState();
                    return;
                }
                
                const data = await res.json();
                
                if (!data.success) {
                    showEmptyState();
                    return;
                }
                
                currentRecords = data.records || [];
                document.getElementById('record-count').textContent = `${currentRecords.length} records`;
                
                if (currentRecords.length === 0) {
                    showEmptyState();
                    return;
                }
                
                renderTable(currentRecords);
                
                // Update local stats from current records
                updateLocalStats();
                
            } catch (e) {
                console.error('[ERROR] Load attendance failed:', e);
                showEmptyState();
            }
        }

        function showEmptyState() {
            document.getElementById('attendance-table').innerHTML = '';
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('record-count').textContent = '0 records';
            currentRecords = [];
            updateLocalStats(); // Reset stats display
        }

        // ========================================
        // LOCAL STATS CALCULATION
        // Calculates breakdown from currentRecords
        // since backend doesn't provide this data
        // ========================================
        function updateLocalStats() {
            // Count status from currently loaded records
            let onTime = 0;
            let late = 0;
            let absent = 0;
            
            currentRecords.forEach(r => {
                switch (r.status) {
                    case 'present':
                        onTime++;
                        break;
                    case 'late':
                        late++;
                        break;
                    case 'absent':
                        absent++;
                        break;
                    default:
                        // Unknown status - count as present
                        onTime++;
                }
            });
            
            // Update the breakdown cards with local data
            document.getElementById('count-ontime').textContent = onTime;
            document.getElementById('count-late').textContent = late;
            document.getElementById('count-absent').textContent = absent;
            
            // Enable the cards since we now have local data
            document.getElementById('summary-cards').classList.remove('card-disabled');
            document.getElementById('summary-unavailable').classList.add('hidden');
            
            // Update the breakdown notice
            const notice = document.getElementById('breakdown-notice');
            if (currentRecords.length > 0) {
                notice.classList.add('hidden');
            } else {
                notice.innerHTML = '<i class="fas fa-info-circle mr-1"></i> No records to calculate breakdown';
                notice.classList.remove('hidden');
            }
            
            // Update attendance rate from local data
            const total = currentRecords.length;
            if (total > 0) {
                const presentCount = onTime + late; // Present includes on-time and late
                const rate = Math.round((presentCount / total) * 100);
                document.getElementById('attendance-rate').textContent = `${rate}%`;
                document.getElementById('attendance-bar').style.width = `${rate}%`;
            }
        }

        function renderTable(records) {
            const tbody = document.getElementById('attendance-table');
            document.getElementById('empty-state').classList.add('hidden');
            
            // Also render mobile cards
            renderMobileCards(records);
            
            tbody.innerHTML = records.map(r => `
                <tr class="clickable-row" onclick="showStudentHistory('${r.nfc_id}', '${escapeHtml(r.name)}')">
                    <td class="px-3 lg:px-4 py-2 lg:py-3 text-center">
                        ${getPhotoThumbnail(r)}
                    </td>
                    <td class="px-3 lg:px-4 py-2 lg:py-3 text-sm font-medium text-gray-900">${escapeHtml(r.name)}</td>
                    <td class="px-3 lg:px-4 py-2 lg:py-3 text-center">
                        <span class="status-dot ${getStatusDotClass(r.status)}" title="${r.status || 'present'}"></span>
                    </td>
                    <td class="px-3 lg:px-4 py-2 lg:py-3 text-sm text-gray-600">${r.time || '--'}</td>
                    <td class="px-3 lg:px-4 py-2 lg:py-3 hidden md:table-cell">
                        <span class="px-2 py-1 rounded text-xs ${r.session === 'AM' ? 'bg-yellow-100 text-yellow-700' : 'bg-indigo-100 text-indigo-700'}">
                            ${r.session || '--'}
                        </span>
                    </td>
                    <td class="px-3 lg:px-4 py-2 lg:py-3 hidden lg:table-cell">
                        <span class="bg-feu-green/10 text-feu-green px-2 py-0.5 rounded text-xs">${r.section || '--'}</span>
                    </td>
                </tr>
            `).join('');
        }
        
        // ========================================
        // PHOTO HELPER FUNCTIONS
        // ========================================
        function getPhotoUrl(record) {
            // Photo path: /photos/{date}/{filename}
            // Record has: date (YYYY-MM-DD HH:MM:SS), photo (filename)
            if (!record.photo) return null;
            const dateStr = record.date ? record.date.split(' ')[0] : new Date().toISOString().split('T')[0];
            return `/photos/${dateStr}/${record.photo}`;
        }
        
        function getPhotoThumbnail(record) {
            const photoUrl = getPhotoUrl(record);
            if (!photoUrl) {
                return `<div class="w-10 h-10 lg:w-12 lg:h-12 rounded-lg bg-gray-200 flex items-center justify-center mx-auto">
                    <i class="fas fa-user text-gray-400 text-sm lg:text-base"></i>
                </div>`;
            }
            return `<img src="${photoUrl}" 
                         alt="${escapeHtml(record.name)}" 
                         class="w-10 h-10 lg:w-12 lg:h-12 rounded-lg object-cover mx-auto cursor-pointer hover:ring-2 hover:ring-feu-green transition shadow-sm"
                         onclick="event.stopPropagation(); showPhotoModal('${escapeHtml(record.name)}', '${photoUrl}', '${record.date || ''}', '${record.time || ''}')"
                         onerror="this.onerror=null; this.parentNode.innerHTML='<div class=\\'w-10 h-10 lg:w-12 lg:h-12 rounded-lg bg-gray-200 flex items-center justify-center mx-auto\\'><i class=\\'fas fa-user text-gray-400 text-sm lg:text-base\\'></i></div>'">`;
        }
        
        // ========================================
        // MOBILE CARDS RENDERING
        // ========================================
        function renderMobileCards(records) {
            const container = document.getElementById('attendance-cards');
            if (!container) return;
            
            container.innerHTML = records.map(r => {
                const photoUrl = getPhotoUrl(r);
                const photoHtml = photoUrl 
                    ? `<img src="${photoUrl}" alt="${escapeHtml(r.name)}" class="w-12 h-12 rounded-lg object-cover shadow-sm" onerror="this.onerror=null; this.src=''; this.className='hidden'; this.nextElementSibling.classList.remove('hidden');">
                       <div class="hidden w-12 h-12 rounded-lg bg-gray-200 flex items-center justify-center"><i class="fas fa-user text-gray-400"></i></div>`
                    : `<div class="w-12 h-12 rounded-lg bg-gray-200 flex items-center justify-center"><i class="fas fa-user text-gray-400"></i></div>`;
                
                return `
                <div class="p-3 hover:bg-gray-50 cursor-pointer" onclick="showStudentHistory('${r.nfc_id}', '${escapeHtml(r.name)}')">
                    <div class="flex items-center gap-3">
                        <div class="flex-shrink-0" onclick="event.stopPropagation(); ${photoUrl ? `showPhotoModal('${escapeHtml(r.name)}', '${photoUrl}', '${r.date || ''}', '${r.time || ''}')` : ''}">
                            ${photoHtml}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${escapeHtml(r.name)}</p>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="status-dot ${getStatusDotClass(r.status)}"></span>
                                <span class="text-xs text-gray-500">${r.time || '--'}</span>
                                <span class="px-1.5 py-0.5 rounded text-[10px] ${r.session === 'AM' ? 'bg-yellow-100 text-yellow-700' : 'bg-indigo-100 text-indigo-700'}">${r.session || '--'}</span>
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            <span class="bg-feu-green/10 text-feu-green px-2 py-0.5 rounded text-xs">${r.section || '--'}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function addRecordToTable(record, prepend = false) {
            const tbody = document.getElementById('attendance-table');
            document.getElementById('empty-state').classList.add('hidden');
            
            const row = document.createElement('tr');
            row.className = 'clickable-row fade-in';
            row.onclick = () => showStudentHistory(record.nfc_id, record.name);
            row.innerHTML = `
                <td class="px-3 lg:px-4 py-2 lg:py-3 text-center">
                    ${getPhotoThumbnail(record)}
                </td>
                <td class="px-3 lg:px-4 py-2 lg:py-3 text-sm font-medium text-gray-900">${escapeHtml(record.name)}</td>
                <td class="px-3 lg:px-4 py-2 lg:py-3 text-center">
                    <span class="status-dot ${getStatusDotClass(record.status)}" title="${record.status || 'present'}"></span>
                </td>
                <td class="px-3 lg:px-4 py-2 lg:py-3 text-sm text-gray-600">${record.time || '--'}</td>
                <td class="px-3 lg:px-4 py-2 lg:py-3 hidden md:table-cell">
                    <span class="px-2 py-1 rounded text-xs ${record.session === 'AM' ? 'bg-yellow-100 text-yellow-700' : 'bg-indigo-100 text-indigo-700'}">
                        ${record.session || '--'}
                    </span>
                </td>
                <td class="px-3 lg:px-4 py-2 lg:py-3 hidden lg:table-cell">
                    <span class="bg-feu-green/10 text-feu-green px-2 py-0.5 rounded text-xs">${record.section || '--'}</span>
                </td>
            `;
            
            if (prepend) {
                tbody.insertBefore(row, tbody.firstChild);
                currentRecords.unshift(record);
            } else {
                tbody.appendChild(row);
                currentRecords.push(record);
            }
            
            // Also update mobile cards
            renderMobileCards(currentRecords);
            
            document.getElementById('record-count').textContent = `${currentRecords.length} records`;
        }

        // ========================================
        // STATUS DOT CLASS
        // Based strictly on status field from API
        // ========================================
        function getStatusDotClass(status) {
            switch (status) {
                case 'present': return 'status-present';
                case 'late': return 'status-late';
                case 'absent': return 'status-absent';
                default: return 'status-unknown'; // Unknown or missing status
            }
        }

        // ========================================
        // LOAD STATS
        // Backend: GET /api/stats (general stats)
        //          GET /api/stats/summary (breakdown)
        // Respects academic calendar status
        // ========================================
        async function loadStats() {
            try {
                // Get current filters
                const section = document.getElementById('section-select').value;
                const today = new Date().toISOString().split('T')[0];
                
                // Build summary URL with filters
                let summaryUrl = `/api/stats/summary?date=${today}`;
                if (section) {
                    summaryUrl += `&section=${encodeURIComponent(section)}`;
                } else {
                    const sections = currentUser.sections_handled || [];
                    if (sections.length > 0) {
                        summaryUrl += `&sections=${encodeURIComponent(sections.join(','))}`;
                    }
                }
                
                // Fetch both general stats and summary in parallel
                const [statsRes, summaryRes] = await Promise.all([
                    fetch('/api/stats', { credentials: 'include' }),
                    fetch(summaryUrl, { credentials: 'include' })
                ]);
                
                const statsData = await statsRes.json();
                const summaryData = await summaryRes.json();
                
                // General stats (total students, attendance rate from global)
                if (statsData.success) {
                    document.getElementById('total-students').textContent = statsData.stats.students || 0;
                }
                
                // Check calendar status first
                if (summaryData.success && summaryData.isInstructional === false) {
                    // Non-instructional day - show special state
                    showNonInstructionalDay(summaryData.calendarLabel, summaryData.calendarReason);
                    return;
                }
                
                // Hide any calendar notice
                hideCalendarNotice();
                
                // Summary stats (breakdown)
                if (summaryData.success && summaryData.stats) {
                    const summary = summaryData.stats;
                    
                    // Update counts
                    document.getElementById('count-ontime').textContent = summary.onTime;
                    document.getElementById('count-late').textContent = summary.late;
                    document.getElementById('count-absent').textContent = summary.absent;
                    
                    // Update attendance rate from summary (section-specific)
                    const rate = summary.attendanceRate || 0;
                    document.getElementById('attendance-rate').textContent = `${rate}%`;
                    document.getElementById('attendance-bar').style.width = `${rate}%`;
                    
                    // Enable summary cards
                    breakdownAvailable = true;
                    document.getElementById('summary-cards').classList.remove('card-disabled');
                    document.getElementById('summary-unavailable').classList.add('hidden');
                    document.getElementById('breakdown-notice').classList.add('hidden');
                } else {
                    // Summary endpoint failed - show graceful degradation
                    breakdownAvailable = false;
                    showBreakdownUnavailable();
                }
                
            } catch (e) {
                console.error('[ERROR] Load stats failed:', e);
                showStatsUnavailable();
            }
        }

        // ========================================
        // CALENDAR STATUS DISPLAY
        // Shows when day is non-instructional
        // ========================================
        function showNonInstructionalDay(label, reason) {
            // Update breakdown notice with calendar info
            const notice = document.getElementById('breakdown-notice');
            notice.innerHTML = `
                <i class="fas fa-calendar-xmark mr-2"></i>
                <span class="font-semibold">${escapeHtml(label)}</span>
                ${reason ? `<span class="ml-2 opacity-80">- ${escapeHtml(reason)}</span>` : ''}
            `;
            notice.classList.remove('hidden');
            
            // Show N/A on summary cards
            document.getElementById('count-ontime').textContent = 'N/A';
            document.getElementById('count-late').textContent = 'N/A';
            document.getElementById('count-absent').textContent = 'N/A';
            document.getElementById('attendance-rate').textContent = 'N/A';
            document.getElementById('attendance-bar').style.width = '0%';
            
            // Disable cards with reduced opacity
            document.getElementById('summary-cards').classList.add('card-disabled');
            
            // Show unavailable banner with calendar-specific message
            const unavailable = document.getElementById('summary-unavailable');
            unavailable.innerHTML = `
                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                <span class="text-blue-700 text-sm">
                    <strong>${escapeHtml(label)}</strong> - Attendance is not recorded on this day.
                    ${reason ? `<br><span class="text-blue-500">${escapeHtml(reason)}</span>` : ''}
                </span>
            `;
            unavailable.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-center';
            unavailable.classList.remove('hidden');
        }

        function hideCalendarNotice() {
            const unavailable = document.getElementById('summary-unavailable');
            unavailable.className = 'hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 text-center';
        }

        function showBreakdownUnavailable() {
            // Show placeholder with clear messaging
            document.getElementById('count-ontime').textContent = 'N/A';
            document.getElementById('count-late').textContent = 'N/A';
            document.getElementById('count-absent').textContent = 'N/A';
            document.getElementById('summary-cards').classList.add('card-disabled');
            document.getElementById('summary-unavailable').classList.remove('hidden');
            document.getElementById('breakdown-notice').classList.remove('hidden');
        }

        function showStatsUnavailable() {
            document.getElementById('total-students').textContent = '--';
            document.getElementById('attendance-rate').textContent = '--%';
            document.getElementById('attendance-bar').style.width = '0%';
            showBreakdownUnavailable();
        }

        function updateStats() {
            // Re-fetch stats when new attendance comes in
            loadStats();
        }

        // ========================================
        // STUDENT DETAIL MODAL
        // Backend: GET /api/attendance/student/:nfc_id
        // Shows summary cards + attendance history
        // ========================================
        async function showStudentHistory(nfcId, name) {
            // Open the new detail modal
            document.getElementById('detail-student-name').textContent = name;
            document.getElementById('detail-student-section').textContent = 'Loading...';
            document.getElementById('detail-records').innerHTML = '<tr><td colspan="4" class="px-3 py-10 text-center"><img src="/assets/animations/tamtap-walking.gif" alt="Loading..." class="w-12 h-12 mx-auto mb-2"><span class="text-gray-400 text-sm">Loading history...</span></td></tr>';
            
            // Reset summary
            ['detail-total', 'detail-present', 'detail-late', 'detail-absent', 'detail-excused', 'detail-rate'].forEach(id => {
                document.getElementById(id).textContent = '--';
            });
            
            document.getElementById('student-detail-modal').classList.remove('hidden');
            document.getElementById('student-detail-modal').classList.add('flex');
            
            try {
                const res = await fetch(`/api/attendance/student/${nfcId}`, { credentials: 'include' });
                const data = await res.json();
                
                if (!data.success) {
                    document.getElementById('detail-records').innerHTML = `
                        <tr><td colspan="4" class="px-3 py-8 text-center text-red-400">
                            <i class="fas fa-exclamation-circle text-2xl mb-2"></i><br>
                            ${data.error || 'Failed to load'}
                        </td></tr>`;
                    return;
                }
                
                // Update student info
                if (data.student) {
                    document.getElementById('detail-student-name').textContent = data.student.name;
                    document.getElementById('detail-student-section').textContent = `${data.student.grade || ''} ${data.student.section}`.trim();
                }
                
                // Update summary cards
                if (data.summary) {
                    document.getElementById('detail-total').textContent = data.summary.totalDays;
                    document.getElementById('detail-present').textContent = data.summary.present;
                    document.getElementById('detail-late').textContent = data.summary.late;
                    document.getElementById('detail-absent').textContent = data.summary.absent;
                    document.getElementById('detail-excused').textContent = data.summary.excused;
                    document.getElementById('detail-rate').textContent = `${data.summary.attendanceRate}%`;
                }
                
                // Render records
                if (!data.records || data.records.length === 0) {
                    document.getElementById('detail-records').innerHTML = `
                        <tr><td colspan="4" class="px-3 py-8 text-center text-gray-400">
                            <i class="fas fa-inbox text-2xl mb-2"></i><br>No attendance records
                        </td></tr>`;
                    return;
                }
                
                document.getElementById('detail-records').innerHTML = data.records.map(r => {
                    const dateStr = r.date ? r.date.split(' ')[0] : '--';
                    const photoUrl = r.photo ? `/photos/${dateStr}/${r.photo}` : null;
                    
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-2 sm:px-3 py-2 text-gray-700">${dateStr}</td>
                            <td class="px-2 sm:px-3 py-2 text-gray-600">${r.time || '--'}</td>
                            <td class="px-2 sm:px-3 py-2 text-center">
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs ${getStatusBadgeClass(r.status)}">
                                    <span class="status-dot ${getStatusDotClass(r.status)}"></span>
                                    <span class="hidden sm:inline">${r.status || 'present'}</span>
                                </span>
                            </td>
                            <td class="px-2 sm:px-3 py-2 text-center">
                                ${photoUrl 
                                    ? `<button onclick="event.stopPropagation(); showPhotoModal('${escapeHtml(data.student?.name || name)}', '${photoUrl}', '${r.date}', '${r.time}')" class="text-feu-green hover:text-feu-green-dark"><i class="fas fa-image"></i></button>`
                                    : `<span class="text-gray-300"><i class="fas fa-image"></i></span>`
                                }
                            </td>
                        </tr>`;
                }).join('');
                
            } catch (e) {
                console.error('[ERROR] Load student detail failed:', e);
                document.getElementById('detail-records').innerHTML = `
                    <tr><td colspan="4" class="px-3 py-8 text-center text-red-400">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i><br>Failed to load history
                    </td></tr>`;
            }
        }
        
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'present': return 'bg-green-100 text-green-700';
                case 'late': return 'bg-yellow-100 text-yellow-700';
                case 'absent': return 'bg-gray-200 text-gray-700';
                case 'excused': return 'bg-blue-100 text-blue-700';
                default: return 'bg-gray-100 text-gray-600';
            }
        }

        function closeStudentDetailModal() {
            document.getElementById('student-detail-modal').classList.add('hidden');
            document.getElementById('student-detail-modal').classList.remove('flex');
        }
        
        // Legacy alias for backward compatibility
        function closeHistoryModal() {
            closeStudentDetailModal();
        }

        // ========================================
        // PHOTO MODAL
        // Displays attendance photo in larger view
        // ========================================
        function showPhotoModal(name, photoUrl, date, time) {
            const modal = document.getElementById('photo-modal');
            const img = document.getElementById('photo-modal-image');
            const loading = document.getElementById('photo-loading');
            const details = document.getElementById('photo-details');
            
            // Set student name
            document.getElementById('photo-student-name').textContent = name;
            
            // Show loading spinner
            loading.classList.remove('hidden');
            img.classList.add('opacity-0');
            
            // Set image source
            img.src = photoUrl;
            
            // Handle image load
            img.onload = function() {
                loading.classList.add('hidden');
                img.classList.remove('opacity-0');
            };
            
            // Handle image error
            img.onerror = function() {
                loading.innerHTML = '<i class="fas fa-image text-3xl text-gray-400"></i><p class="text-sm text-gray-500 mt-2">Photo not available</p>';
            };
            
            // Set details
            const dateDisplay = date ? date.split(' ')[0] : 'Unknown date';
            const timeDisplay = time || 'Unknown time';
            details.innerHTML = `
                <p><i class="fas fa-calendar text-feu-green mr-1.5"></i> ${dateDisplay}</p>
                <p class="mt-1"><i class="fas fa-clock text-feu-green mr-1.5"></i> ${timeDisplay}</p>
            `;
            
            // Show modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        function closePhotoModal() {
            const modal = document.getElementById('photo-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            
            // Reset image
            document.getElementById('photo-modal-image').src = '';
            document.getElementById('photo-loading').classList.remove('hidden');
            document.getElementById('photo-loading').innerHTML = '<img src="/assets/animations/tamtap-walking.gif" alt="Loading..." class="w-16 h-16 sm:w-20 sm:h-20"><p class="text-sm text-feu-green mt-2">Loading photo...</p>';
        }

        // ========================================
        // PERSONAL INFO MODAL
        // Backend: GET /api/auth/me
        // ========================================
        function showPersonalInfo() {
            closeSettingsMenu();
            
            const content = document.getElementById('personal-content');
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center gap-4 pb-4 border-b">
                        <div class="bg-feu-green text-white w-16 h-16 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-2xl"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-lg text-gray-800">${escapeHtml(currentUser.name)}</p>
                            <p class="text-sm text-feu-green">${currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)}</p>
                        </div>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase mb-1">Username</p>
                        <p class="text-gray-800">${escapeHtml(currentUser.username)}</p>
                    </div>
                    ${currentUser.email ? `
                    <div>
                        <p class="text-xs text-gray-500 uppercase mb-1">Email</p>
                        <p class="text-gray-800">${escapeHtml(currentUser.email)}</p>
                    </div>
                    ` : ''}
                    <div>
                        <p class="text-xs text-gray-500 uppercase mb-1">Sections Handled</p>
                        <div class="flex flex-wrap gap-2">
                            ${(currentUser.sections_handled || []).map(s => 
                                `<span class="bg-feu-green/10 text-feu-green px-3 py-1 rounded-full text-sm">${escapeHtml(s)}</span>`
                            ).join('') || '<span class="text-gray-400">None assigned</span>'}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('personal-modal').classList.remove('hidden');
            document.getElementById('personal-modal').classList.add('flex');
        }

        function closePersonalModal() {
            document.getElementById('personal-modal').classList.add('hidden');
            document.getElementById('personal-modal').classList.remove('flex');
        }

        // ========================================
        // HELP CENTER
        // ========================================
        function showHelpCenter() {
            closeSettingsMenu();
            Swal.fire({
                title: 'Help Center',
                html: `
                    <div class="text-left text-sm space-y-3">
                        <p><strong>TAMTAP</strong> is an NFC-based attendance tracking system.</p>
                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>View attendance for your assigned sections</p>
                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Click on a student row to view their history</p>
                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Export attendance data to CSV</p>
                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Real-time updates via Socket.IO</p>
                        <hr class="my-3">
                        <p class="text-gray-500">For account issues, contact your administrator.</p>
                    </div>
                `,
                confirmButtonColor: '#006A4E',
                confirmButtonText: 'Got it!'
            });
        }

        // ========================================
        // SETTINGS MENU
        // ========================================
        function toggleSettingsMenu() {
            const menu = document.getElementById('settings-menu');
            menu.classList.toggle('hidden');
        }

        function closeSettingsMenu() {
            document.getElementById('settings-menu').classList.add('hidden');
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('settings-menu');
            if (!e.target.closest('#settings-menu') && !e.target.closest('[onclick="toggleSettingsMenu()"]')) {
                menu.classList.add('hidden');
            }
            // Close export menu
            const exportMenu = document.getElementById('export-menu');
            if (!e.target.closest('#export-menu') && !e.target.closest('[onclick="toggleExportMenu()"]')) {
                exportMenu.classList.add('hidden');
            }
        });

        // ========================================
        // CSV EXPORT
        // ========================================
        function exportCSV() {
            if (currentRecords.length === 0) {
                Swal.fire({ 
                    icon: 'warning', 
                    title: 'No Data', 
                    text: 'No records to export',
                    confirmButtonColor: '#006A4E'
                });
                return;
            }
            
            const section = document.getElementById('section-select').value || 'all';
            const today = new Date().toISOString().split('T')[0];
            
            const headers = ['Name', 'Section', 'Date', 'Time', 'Session', 'Status'];
            const rows = currentRecords.map(r => [
                r.name,
                r.section || '',
                r.date || '',
                r.time || '',
                r.session || '',
                r.status || 'present'
            ]);
            
            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_${section}_${today}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'CSV exported!',
                showConfirmButton: false,
                timer: 2000
            });
            closeExportMenu();
        }
        
        // ========================================
        // EXPORT MENU
        // ========================================
        function toggleExportMenu() {
            const menu = document.getElementById('export-menu');
            menu.classList.toggle('hidden');
        }
        
        function closeExportMenu() {
            document.getElementById('export-menu').classList.add('hidden');
        }
        
        // ========================================
        // XLSX EXPORT (Backend)
        // ========================================
        async function exportXLSX() {
            closeExportMenu();
            
            const section = document.getElementById('section-select').value;
            const { from, to } = getDateRange();
            
            Swal.fire({
                title: 'Generating Excel...',
                text: 'Please wait',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            
            try {
                const params = new URLSearchParams({ from, to });
                if (section) params.append('section', section);
                
                const res = await fetch(`/api/export/xlsx?${params}`, { credentials: 'include' });
                
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.message || 'Export failed');
                }
                
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance_${section || 'all'}_${from}_to_${to}.xlsx`;
                a.click();
                URL.revokeObjectURL(url);
                
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Excel exported!',
                    showConfirmButton: false,
                    timer: 2000
                });
            } catch (e) {
                console.error('[ERROR] XLSX export:', e);
                Swal.fire({
                    icon: 'error',
                    title: 'Export Failed',
                    text: e.message || 'Failed to generate Excel file',
                    confirmButtonColor: '#0a8249'
                });
            }
        }
        
        // ========================================
        // PDF EXPORT (Backend)
        // ========================================
        async function exportPDF() {
            closeExportMenu();
            
            const section = document.getElementById('section-select').value;
            const { from, to } = getDateRange();
            
            Swal.fire({
                title: 'Generating PDF...',
                text: 'Please wait',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            
            try {
                const params = new URLSearchParams({ from, to });
                if (section) params.append('section', section);
                
                const res = await fetch(`/api/export/pdf?${params}`, { credentials: 'include' });
                
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.message || 'Export failed');
                }
                
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance_report_${section || 'all'}_${from}_to_${to}.pdf`;
                a.click();
                URL.revokeObjectURL(url);
                
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'PDF exported!',
                    showConfirmButton: false,
                    timer: 2000
                });
            } catch (e) {
                console.error('[ERROR] PDF export:', e);
                Swal.fire({
                    icon: 'error',
                    title: 'Export Failed',
                    text: e.message || 'Failed to generate PDF file',
                    confirmButtonColor: '#0a8249'
                });
            }
        }

        // ========================================
        // UTILITIES
        // ========================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modals on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeHistoryModal();
                closePersonalModal();
                closePhotoModal();
                closeSettingsMenu();
            }
        });

        // Modal backdrop clicks
        document.getElementById('history-modal').addEventListener('click', (e) => {
            if (e.target.id === 'history-modal') closeHistoryModal();
        });
        document.getElementById('personal-modal').addEventListener('click', (e) => {
            if (e.target.id === 'personal-modal') closePersonalModal();
        });
        document.getElementById('photo-modal').addEventListener('click', (e) => {
            if (e.target.id === 'photo-modal') closePhotoModal();
        });

        // ========================================
        // INIT
        // ========================================
        checkAuth();
    </script>
</body>
</html>
